<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion – URL Matcher</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --accent:#2563eb;
      --accent-600:#1d4ed8;

      --ok:#16a34a;
      --err:#dc2626;

      --shadow:0 10px 30px #0000000a;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}
    .topbar{
      position:sticky;top:0;z-index:40;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--border)
    }
    .nav{display:flex;align-items:center;justify-content:space-between;height:60px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .brand .logo{width:10px;height:24px;background:var(--accent);border-radius:4px}

    .page{padding:24px 0 40px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow)
    }
    .auth-wrap{max-width:560px;margin:0 auto}
    .title{font-weight:900;font-size:18px;margin:0 0 6px 0}
    .sub{margin:0;color:var(--muted);line-height:1.45;font-size:13px}

    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .grow{flex:1 1 240px}

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;font-weight:700}
    input[type=email],input[type=password]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fafafa;color:var(--text)
    }

    .btn{cursor:pointer;border:none;border-radius:10px;font-weight:800;padding:10px 14px}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-600)}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn.ghost:hover{background:#fafafa}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .status{margin-top:12px;font-size:13px}
    .status.ok{color:var(--ok);font-weight:800}
    .status.err{color:var(--err);font-weight:800}

    .footer{margin:16px 0 0;color:var(--muted);font-size:12px;text-align:center}
    .help{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.45}
    code{background:#eef2ff;border:1px solid var(--border);padding:1px 6px;border-radius:8px}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Mets EXACTEMENT les mêmes valeurs que dans index.html
    window.SUPABASE_URL="https://srvvdrhiaygklqjijdtq.supabase.co";
    window.SUPABASE_PUBLISHABLE_KEY="sb_publishable_Tm5K5o-Fq_UBHP9Qp6JBog_rtKQjpDi";
  </script>
</head>

<body>
  <div class="topbar">
    <div class="container nav">
      <div class="brand">
        <div class="logo"></div><span>URL Matcher</span>
      </div>
      <div style="font-size:13px;color:var(--muted);font-weight:700">Connexion</div>
    </div>
  </div>

  <div class="container page">
    <div class="auth-wrap">
      <div class="card">
        <div class="title">Connexion</div>
        <p class="sub">Connecte-toi pour accéder à l’application.</p>

        <div class="row">
          <div class="grow">
            <label>Email</label>
            <input id="authEmail" type="email" placeholder="you@domain.tld" autocomplete="email">
          </div>
          <div class="grow">
            <label>Mot de passe</label>
            <input id="authPassword" type="password" placeholder="••••••••" autocomplete="current-password">
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="btnLogin" type="button">Se connecter</button>
          <button class="btn ghost" id="btnSignup" type="button">Créer un compte</button>
        </div>

        <div class="help">
          Si tu viens de créer un compte, Supabase peut exiger la validation email.
          Dans ce cas, clique le lien reçu puis reviens ici.
        </div>

        <div id="authStatus" class="status"></div>
      </div>

      <div class="footer">© Tigui Camara</div>
    </div>
  </div>

<script>
/* ===================== Supabase Client ===================== */
const supabaseClient = window.supabase.createClient(
  window.SUPABASE_URL,
  window.SUPABASE_PUBLISHABLE_KEY,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const elStatus = document.getElementById('authStatus');
const elEmail = document.getElementById('authEmail');
const elPass = document.getElementById('authPassword');
const btnLogin = document.getElementById('btnLogin');
const btnSignup = document.getElementById('btnSignup');

function setStatus(msg, kind){
  elStatus.textContent = msg || '';
  elStatus.className = 'status ' + (kind || '');
}
function busy(on){
  btnLogin.disabled = !!on;
  btnSignup.disabled = !!on;
}

function nextParam(){
  const u = new URL(location.href);
  return u.searchParams.get('next') || './index.html';
}

// Si déjà connecté -> redirection directe
(async function boot(){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(session){
    window.location.href = nextParam();
  }
})();

btnLogin.addEventListener('click', async ()=>{
  const email = (elEmail.value || '').trim();
  const password = elPass.value || '';
  if(!email || !password){
    setStatus('Renseigne email et mot de passe.', 'err');
    return;
  }

  setStatus('Connexion…', '');
  busy(true);
  try{
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if(error){
      setStatus('Erreur: ' + error.message, 'err');
      return;
    }
    setStatus('Connecté. Redirection…', 'ok');
    window.location.href = nextParam();
  }catch(e){
    setStatus('Erreur inattendue: ' + (e?.message || String(e)), 'err');
  }finally{
    busy(false);
  }
});

btnSignup.addEventListener('click', async ()=>{
  const email = (elEmail.value || '').trim();
  const password = elPass.value || '';
  if(!email || !password){
    setStatus('Renseigne email et mot de passe (min. 6 caractères).', 'err');
    return;
  }

  setStatus('Création du compte…', '');
  busy(true);
  try{
    // Important: emailRedirectTo doit pointer vers login.html
    // (comme ça Supabase renvoie ici après validation email)
    const redirectTo = `${location.origin}${location.pathname.replace(/[^/]+$/, 'login.html')}`;

    const { error } = await supabaseClient.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: redirectTo }
    });

    if(error){
      setStatus('Erreur: ' + error.message, 'err');
      return;
    }

    setStatus('Compte créé. Vérifie ton email (validation) puis reconnecte-toi.', 'ok');
  }catch(e){
    setStatus('Erreur inattendue: ' + (e?.message || String(e)), 'err');
  }finally{
    busy(false);
  }
});

// Enter = login
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') btnLogin.click();
});
</script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matching 404/200 – Frontend</title>
  <style>
    :root{--bg:#0b1020;--card:#121a35;--muted:#8aa0ff;--text:#e6ebff;--accent:#4f66ff;--ok:#2ecc71;--err:#ff5c5c}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1020,#0b1020 40%,#111936);color:var(--text)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .title{font-weight:700;font-size:28px;letter-spacing:.3px}
    .sub{opacity:.85;margin-top:4px}
    .card{background:var(--card);border:1px solid #21306a66;border-radius:14px;padding:16px;box-shadow:0 10px 40px #0004}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    input[type=text], input[type=url], input[type=number], textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3a80;background:#0e1530;color:var(--text)}
    textarea{min-height:120px;white-space:pre-wrap}
    .btn{cursor:pointer;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn.secondary{background:#1f2b5c}
    .btn.ghost{background:transparent;border:1px solid #2a3a80}
    .tabs{display:flex;gap:10px;margin:18px 0}
    .tab{padding:10px 12px;border-radius:10px;background:#142057;cursor:pointer;border:1px solid #223072}
    .tab.active{background:var(--accent)}
    .hide{display:none}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#193f2b;color:#9ff1bf}
    .err{background:#43202b;color:#ffb0b0}
    .muted{color:#a9b6ff99;font-size:14px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #2a3a80;padding:6px 8px}
    .sticky{position:sticky;top:0;background:var(--card);z-index:2}
    .footer{opacity:.7;margin:22px 0 40px}
    .code{background:#0a0f25;border:1px solid #1c2b69;padding:10px;border-radius:10px;overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="title">Matching 404 → 200 – Interface Web</div>
    <div class="sub">Frontend statique. Upload → <code>/match</code> Cloud Run → téléchargement du résultat.</div>

    <div class="card" style="margin-top:16px">
      <div class="row">
        <div class="grow">
          <label>URL de l'API (Cloud Run)</label>
          <input id="apiBase" type="url" value="https://url-matcher-70649262164.europe-west1.run.app" />
          <div class="muted">Doit exposer <code>POST /match</code>. Le health check teste <code>/</code>, <code>/openapi.json</code>, <code>OPTIONS /match</code> ou un <code>POST /match</code> “à vide”.</div>
        </div>
        <div class="grow" style="align-self:flex-end">
          <label><input id="useProxy" type="checkbox" /> Utiliser proxy relatif <code>/api/proxy</code> (Vercel)</label>
          <div class="muted">Coche si CORS bloque ou par défaut en production Vercel.</div>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="btnHealth">Test de fonctionnement</button>
          <span id="healthBadge" class="badge muted">en attente…</span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="config">Configuration</div>
      <div class="tab" data-tab="test">Tester une URL</div>
      <div class="tab" data-tab="matching">Matching 404/200</div>
      <div class="tab" data-tab="docs">Documentation</div>
    </div>

    <!-- CONFIGURATION -->
    <section id="tab-config" class="card">
      <div class="row">
        <div class="grow">
          <label>Dictionnaire Excel (colonnes = noms de dicos, lignes = "clé, syn1, syn2…")</label>
          <input id="fileDico" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="grow">
          <label>Traductions Excel (colonnes SOURCE, TRANSLATION)</label>
          <input id="fileTrad" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="grow">
          <label>Parents (optionnel) – Excel avec colonne URL</label>
          <input id="fileParents" type="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="grow"><label>Stopwords (virgules)</label><input id="inpStop" type="text" /></div>
        <div class="grow"><label>Exceptions normalisation (virgules)</label><input id="inpExc" type="text" /></div>
        <div class="grow"><label>Expressions multi-mots (virgules)</label><input id="inpMulti" type="text" /></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="grow"><label>Regex référence</label><input id="inpRegex" type="text" value="(?i)ref[:\- ]?([a-z0-9\-]+)" /></div>
        <div class="grow"><label>Score minimum (UI)</label><input id="inpMin" type="number" step="0.1" value="0.5" /></div>
      </div>

      <div style="margin-top:12px">
        <button class="btn" id="btnApply">Mettre à jour la configuration</button>
      </div>

      <div style="margin-top:12px">
        <label>Logs configuration</label>
        <textarea id="logsCfg" readonly></textarea>
      </div>
    </section>

    <!-- TEST URL -->
    <section id="tab-test" class="card hide">
      <div class="row">
        <div class="grow">
          <label>URL</label>
          <input id="testUrl" type="text" placeholder="https://www.exemple.com/produit/ref-AB1234?color=red" />
        </div>
        <div style="display:flex;align-items:flex-end"><button class="btn" id="btnTest">Tester</button></div>
      </div>
      <div style="margin-top:12px">
        <label>Résultat</label>
        <textarea id="testOut" readonly></textarea>
      </div>
    </section>

    <!-- MATCHING -->
    <section id="tab-matching" class="card hide">
      <div class="row">
        <div class="grow">
          <label>Fichier 404 (sheet "404", col "URL_404")</label>
          <input id="file404" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="grow">
          <label>Fichier 200 (sheet "200", col "URL_200")</label>
          <input id="file200" type="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="grow"><button class="btn secondary" id="btnEstimate">Estimation (approx.)</button></div>
        <div class="grow" style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="btnClear">Vider</button>
          <button class="btn" id="btnRun">Lancer le matching</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Logs matching</label>
        <textarea id="logsMatch" readonly></textarea>
      </div>
    </section>

    <!-- DOCS -->
    <section id="tab-docs" class="card hide">
      <p><b>Format attendu :</b></p>
      <ul>
        <li>Excel "404" avec onglet <code>404</code> + colonne <code>URL_404</code>.</li>
        <li>Excel "200" avec onglet <code>200</code> + colonne <code>URL_200</code>.</li>
      </ul>
      <p>Proxy Vercel activable via la case “Utiliser proxy”.</p>
    </section>

    <div class="footer">© Interface statique – Vercel Ready</div>
  </div>

<script>
/* === JS principal === */

const state={dicos:{},dicoWeights:{},translations:{},parents:[],cfg:{stop:new Set(),exc:new Set(),multi:[],ref:'(?i)ref[:\\- ]?([a-z0-9\\-]+)',min:0.5}};
function saveLocal(){localStorage.setItem('matcherFront',JSON.stringify({dicoWeights:state.dicoWeights,cfg:{stop:[...state.cfg.stop],exc:[...state.cfg.exc],multi:state.cfg.multi,ref:state.cfg.ref,min:state.cfg.min},translations:state.translations,parents:state.parents}))}
function loadLocal(){const raw=localStorage.getItem('matcherFront');if(!raw)return;try{const obj=JSON.parse(raw);state.dicoWeights=obj.dicoWeights||{};state.cfg.stop=new Set(obj?.cfg?.stop||[]);state.cfg.exc=new Set(obj?.cfg?.exc||[]);state.cfg.multi=obj?.cfg?.multi||[];state.cfg.ref=obj?.cfg?.ref||state.cfg.ref;state.cfg.min=obj?.cfg?.min??0.5;state.translations=obj.translations||{};state.parents=obj.parents||[]}catch(e){}}
loadLocal();

const tabs=document.querySelectorAll('.tab');
const panels={config:document.getElementById('tab-config'),test:document.getElementById('tab-test'),matching:document.getElementById('tab-matching'),docs:document.getElementById('tab-docs')};
tabs.forEach(t=>{t.addEventListener('click',()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');Object.values(panels).forEach(p=>p.classList.add('hide'));panels[t.dataset.tab].classList.remove('hide')})});

const apiBase=document.getElementById('apiBase');
const useProxy=document.getElementById('useProxy');
const btnHealth=document.getElementById('btnHealth');
const healthBadge=document.getElementById('healthBadge');
const fileDico=document.getElementById('fileDico');
const fileTrad=document.getElementById('fileTrad');
const fileParents=document.getElementById('fileParents');
const inpStop=document.getElementById('inpStop');
const inpExc=document.getElementById('inpExc');
const inpMulti=document.getElementById('inpMulti');
const inpRegex=document.getElementById('inpRegex');
const inpMin=document.getElementById('inpMin');
const btnApply=document.getElementById('btnApply');
const logsCfg=document.getElementById('logsCfg');
const tblDico=document.getElementById('tblDico')?.querySelector('tbody')||document.createElement('tbody');
const testUrl=document.getElementById('testUrl');
const btnTest=document.getElementById('btnTest');
const testOut=document.getElementById('testOut');
const file404=document.getElementById('file404');
const file200=document.getElementById('file200');
const btnEstimate=document.getElementById('btnEstimate');
const btnRun=document.getElementById('btnRun');
const btnClear=document.getElementById('btnClear');
const logsMatch=document.getElementById('logsMatch');

inpStop.value=[...state.cfg.stop].join(', ');
inpExc.value=[...state.cfg.exc].join(', ');
inpMulti.value=state.cfg.multi.join(', ');
inpRegex.value=state.cfg.ref;
inpMin.value=state.cfg.min;

function renderDicoTable(){if(!tblDico)return;tblDico.innerHTML='';Object.keys(state.dicos).forEach(name=>{const tr=document.createElement('tr');const w=state.dicoWeights[name]||{bonus:1,malus:1,active:true};tr.innerHTML=`<td>${name}</td><td><input type="number" value="${w.bonus}" data-k="bonus" style="width:100%"></td><td><input type="number" value="${w.malus}" data-k="malus" style="width:100%"></td><td style="text-align:center"><input type="checkbox" ${w.active?'checked':''} data-k="active"></td>`;tr.querySelectorAll('input').forEach(inp=>{inp.addEventListener('change',()=>{const key=inp.dataset.k;const row=state.dicoWeights[name]||{bonus:1,malus:1,active:true};if(key==='active')row.active=inp.checked;else row[key]=Number(inp.value);state.dicoWeights[name]=row;saveLocal()})});tblDico.appendChild(tr)})}
renderDicoTable();

function logCfg(msg){logsCfg.value+=(logsCfg.value?"\n":"")+msg;logsCfg.scrollTop=logsCfg.scrollHeight}
function logMatch(msg){logsMatch.value+=(logsMatch.value?"\n":"")+msg;logsMatch.scrollTop=logsMatch.scrollHeight}

function normalizeText(s){if(!s)return'';return String(s).toLowerCase().replace(/[-_\/]+/g,' ').trim()}
function tokenize(s){let t=normalizeText(s);state.cfg.multi.forEach(exp=>{const r=new RegExp(exp.replace(/[-\s]+/g,'\\s+'),'gi');t=t.replace(r,exp.replace(/\s+/g,'-'))});let tokens=t.split(/\s+/).filter(Boolean);tokens=tokens.filter(x=>!state.cfg.stop.has(x));tokens=tokens.map(tok=>state.translations[tok]||tok);const active=Object.keys(state.dicos).filter(n=>(state.dicoWeights[n]||{active:true}).active);tokens=tokens.map(tok=>{for(const name of active){const dict=state.dicos[name];for(const key in dict){if(dict[key].has(tok)||key===tok)return key}}return tok});return tokens}
function extractRef(s){try{const m=new RegExp(state.cfg.ref).exec(s);return m?m[1]:null}catch(e){return null}}

/* ====== Prod: forcer proxy + masquer réglages ====== */
function isProd(){
  return location.hostname.endsWith('.vercel.app') || location.hostname === 'frontend-matcher.vercel.app';
}
window.addEventListener('DOMContentLoaded',()=>{
  if(isProd()){
    // Masquer les blocs "URL API" et "Utiliser proxy"
    const apiBlock = document.getElementById('apiBase')?.closest('.grow');
    const proxyBlock = document.getElementById('useProxy')?.closest('.grow');
    if(apiBlock)  apiBlock.style.display='none';
    if(proxyBlock) proxyBlock.style.display='none';
    // Forcer la case proxy (utile si buildUrl se base sur la checkbox en dev)
    if (useProxy) useProxy.checked = true;
  }
});
/* ====== Fin patch prod ====== */

function buildUrl(path){
  const p=path.startsWith('/')?path:'/'+path;
  if (isProd()) {
    // En production: toujours via le proxy Vercel
    return location.origin + '/api/proxy' + p;
  }
  // En dev: garder le comportement existant (checkbox)
  if(useProxy && useProxy.checked){return location.origin+'/api/proxy'+p}
  return apiBase.value.replace(/\/$/,'')+p
}

/* ====== Health check multi-sondes ====== */
async function tryProbe(probe, timeoutMs=4000){
  const controller=new AbortController();
  const t=setTimeout(()=>controller.abort(),timeoutMs);
  const init={method:probe.method,signal:controller.signal,headers:probe.headers||{},redirect:'manual'};
  if(!['GET','HEAD','OPTIONS'].includes(probe.method) && probe.body!==undefined){init.body=probe.body}
  const started=Date.now();
  try{
    const resp=await fetch(buildUrl(probe.path),init);
    const ms=Date.now()-started;
    console.debug(`[health] ${probe.name} -> ${resp.status} (${ms} ms)`);
    const ok=probe.okStatuses.includes(resp.status) || (resp.ok && probe.okStatuses.includes(200));
    return {ok,status:resp.status,ms};
  }catch(err){
    const ms=Date.now()-started;
    console.debug(`[health] ${probe.name} -> erreur ${err?.name==='AbortError'?'timeout':(err?.message||'inconnue')} (${ms} ms)`);
    return {ok:false,error:err,ms};
  }finally{
    clearTimeout(t);
  }
}

const HEALTH_PROBES=[
  {name:'GET /',             path:'/',             method:'GET',     okStatuses:[200,204]},
  {name:'HEAD /',            path:'/',             method:'HEAD',    okStatuses:[200,204]},
  {name:'GET /openapi.json', path:'/openapi.json', method:'GET',     okStatuses:[200]},
  {name:'OPTIONS /match',    path:'/match',        method:'OPTIONS', okStatuses:[200,204]},
  {name:'POST /match (dry)', path:'/match',        method:'POST',    okStatuses:[200,400,415,422], body:'{}', headers:{'content-type':'application/json'}}
];

btnHealth.addEventListener('click', async ()=>{
  healthBadge.textContent='test…';
  healthBadge.className='badge muted';
  for(const probe of HEALTH_PROBES){
    const r=await tryProbe(probe);
    if(r.ok){
      healthBadge.textContent='OK';
      healthBadge.className='badge ok';
      return;
    }
  }
  healthBadge.textContent='ERREUR';
  healthBadge.className='badge err';
});
/* ====== Fin health check ====== */

btnApply.addEventListener('click',()=>{state.cfg.stop=new Set(inpStop.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));state.cfg.exc=new Set(inpExc.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));state.cfg.multi=inpMulti.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);state.cfg.ref=inpRegex.value.trim()||state.cfg.ref;state.cfg.min=Number(inpMin.value)||0.5;saveLocal();logCfg('[CONFIG] Paramètres appliqués.')});

async function readExcel(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});resolve(wb)}catch(err){reject(err)}};reader.onerror=reject;reader.readAsArrayBuffer(file)})}

fileDico.addEventListener('change',async()=>{logsCfg.value='';if(!fileDico.files[0])return;try{const wb=await readExcel(fileDico.files[0]);state.dicos={};wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const df=XLSX.utils.sheet_to_json(sh,{header:1,blankrows:false});if(df.length===0)return;const cols=df[0].map((_,i)=>df.map(row=>row[i]));cols.forEach((col,idx)=>{const dicoName=String(df[0][idx]||`Dico_${idx+1}`);if(!state.dicos[dicoName])state.dicos[dicoName]={};for(let r=1;r<col.length;r++){const cell=col[r];if(cell==null)continue;const items=String(cell).split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);if(items.length===0)continue;const key=items[0];state.dicos[dicoName][key]=(state.dicos[dicoName][key]||new Set());items.forEach(x=>state.dicos[dicoName][key].add(x))}})});renderDicoTable();saveLocal();logCfg(`[DICO] ${Object.keys(state.dicos).length} dictionnaire(s) chargé(s).`)}catch(e){logCfg('[DICO][ERREUR] '+e.message)}});

fileTrad.addEventListener('change',async()=>{if(!fileTrad.files[0])return;try{const wb=await readExcel(fileTrad.files[0]);state.translations={};wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const arr=XLSX.utils.sheet_to_json(sh);arr.forEach(row=>{const s=String(row['SOURCE']||'').trim().toLowerCase();const t=String(row['TRANSLATION']||'').trim().toLowerCase();if(s)state.translations[s]=t})});saveLocal();logCfg(`[TRAD] ${Object.keys(state.translations).length} entrées.`)}catch(e){logCfg('[TRAD][ERREUR] '+e.message)}});

fileParents.addEventListener('change',async()=>{if(!fileParents.files[0])return;try{const wb=await readExcel(fileParents.files[0]);state.parents=[];wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const arr=XLSX.utils.sheet_to_json(sh);arr.forEach(row=>{if(row.URL)state.parents.push(String(row.URL))})});saveLocal();logCfg(`[PARENTS] ${state.parents.length} URLs.`)}catch(e){logCfg('[PARENTS][ERREUR] '+e.message)}});

btnTest.addEventListener('click',()=>{const url=testUrl.value.trim();const logs=[];if(!url){testOut.value='Veuillez saisir une URL.';return}logs.push(`URL brute : ${url}`);const cleaned=url.replace(/^https?:\/\//i,'').replace(/^www\./i,'');logs.push('URL nettoyée (clean) :');logs.push(' → '+cleaned);const tokens=tokenize(cleaned);logs.push('URL après synonymes (apply_synonym_substitution) :');logs.push(' → '+tokens.join(' '));logs.push('Tokens (get_tokens) :');logs.push(tokens.length?(' → '+tokens.join(', ')):' → Aucun token');const ref=extractRef(url);logs.push(ref?`Référence détectée : ${ref}`:'Aucune référence détectée via la regex.');logs.push('Caractéristiques détectées :');const active=Object.keys(state.dicos).filter(n=>(state.dicoWeights[n]||{active:true}).active);if(active.length===0){logs.push(' → Aucun dictionnaire dynamique chargé.')}else{active.forEach(name=>{const dict=state.dicos[name];const hits=new Set();tokens.forEach(tok=>{for(const key in dict){if(dict[key].has(tok))hits.add(key)}});logs.push(hits.size?` [${name}] → ${[...hits].join(', ')}`:` [${name}] → aucune caractéristique trouvée`)})}testOut.value=logs.join('\n')});

btnEstimate.addEventListener('click',async()=>{logsMatch.value='';if(!file404.files[0]||!file200.files[0]){logMatch('Charge les deux fichiers d\'abord.');return}try{const wb404=await readExcel(file404.files[0]);const sh404=wb404.Sheets['404']||wb404.Sheets[wb404.SheetNames[0]];const arr404=XLSX.utils.sheet_to_json(sh404);const wb200=await readExcel(file200.files[0]);const sh200=wb200.Sheets['200']||wb200.Sheets[wb200.SheetNames[0]];const arr200=XLSX.utils.sheet_to_json(sh200);if(arr404.length===0||arr200.length===0){logMatch('[ESTIMATION] Impossible : fichiers vides.');return}const total=arr404.length;const est=(0.035+0.025)*total;const min=(est/60).toFixed(1);logMatch(`[ESTIMATION] ~ ${min} minutes (approximation navigateur).`)}catch(e){logMatch('[ESTIMATION][ERREUR] '+e.message)}});

btnClear.addEventListener('click',()=>{logsMatch.value='';file404.value='';file200.value=''});

btnRun.addEventListener('click',async()=>{logsMatch.value='';if(!file404.files[0]||!file200.files[0]){logMatch('Upload les fichiers d\'abord.');return}try{const form=new FormData();form.append('file404',file404.files[0]);form.append('file200',file200.files[0]);logMatch('[0%] Upload en cours…');const r=await fetch(buildUrl('/match'),{method:'POST',body:form});if(!r.ok){const txt=await r.text();throw new Error('HTTP '+r.status+' – '+txt)}logMatch('[60%] Traitement côté API…');const blob=await r.blob();logMatch('[90%] Réception du résultat…');const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='result.xlsx';document.body.appendChild(a);a.click();a.remove();logMatch('[100%] Terminé. Fichier téléchargé : result.xlsx')}catch(e){logMatch('[ERREUR] '+e.message)}});
</script>
</body>
</html>

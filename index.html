<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URL Matcher</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#5f6b7a; --border:#e5e7eb;
      --accent:#2563eb; --accent-600:#1d4ed8; --ok:#16a34a; --err:#dc2626; --chip:#eef2ff
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:60px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{width:10px;height:24px;background:var(--accent);border-radius:4px}
    .actions{display:flex;align-items:center;gap:10px}
    .user{font-size:14px;color:var(--muted)}
    .btn{cursor:pointer;border:none;border-radius:10px;font-weight:600;padding:10px 14px}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-600)}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn.ghost:hover{background:#fafafa}
    .hidden{display:none !important}

    /* Hero */
    .hero{padding:28px 0 12px}
    .h1{font-size:26px;font-weight:800;margin:0}
    .sub{margin-top:6px;color:var(--muted)}

    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);padding-bottom:8px;margin:18px 0}
    .tab{padding:8px 12px;border-radius:10px;background:var(--chip);color:#1e3a8a;cursor:pointer;border:1px solid var(--border)}
    .tab.active{background:var(--accent);color:#fff}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* Cards / form */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 8px 24px #0000000a}
    .section-title{font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;gap:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    input[type=text],input[type=url],input[type=number],input[type=email],input[type=password],textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fafafa;color:var(--text)
    }
    input[type=file]{width:100%}
    textarea{min-height:110px;white-space:pre-wrap}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.ok{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
    .badge.err{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .badge.info{background:#eff6ff;color:#1e3a8a;border-color:#bfdbfe}

    /* Auth gate */
    #gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#eef2f7;z-index:50}
    #gate .card{width:520px}

    /* Table dictionnaires */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:13px;color:var(--muted);font-weight:600}
    .switch{appearance:none;width:42px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;outline:none;cursor:pointer;transition:.2s}
    .switch:checked{background:var(--accent)}
    .switch:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:.2s;box-shadow:0 1px 3px #0001}
    .switch:checked:before{left:21px}
    details{background:#fafafa;border:1px solid var(--border);border-radius:10px;padding:10px}
    summary{cursor:pointer;font-weight:600}
    .help{font-size:12px;color:var(--muted)}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    window.SUPABASE_URL="https://srvvdrhiaygklqjijdtq.supabase.co";
    window.SUPABASE_PUBLISHABLE_KEY="sb_publishable_Tm5K5o-Fq_UBHP9Qp6JBog_rtKQjpDi";
  </script>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container nav">
      <div class="brand">
        <div class="logo"></div><span>URL&nbsp;Matcher</span>
      </div>
      <div class="actions">
        <span id="currentUser" class="user"></span>
        <button id="btnLoginOpen" class="btn primary">Se connecter</button>
        <button id="btnLogout" class="btn ghost hidden">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- Auth Gate -->
  <div id="gate" class="hidden">
    <div class="card">
      <div class="section-title" style="font-size:18px">Connexion requise</div>
      <div class="row" style="margin-top:6px">
        <div class="grow"><label>Email</label><input id="authEmail" type="email" placeholder="you@domain.tld"></div>
        <div class="grow"><label>Mot de passe</label><input id="authPassword" type="password" placeholder="••••••••"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn primary" id="btnLogin">Se connecter</button>
        <button class="btn ghost" id="btnSignup">Créer un compte</button>
      </div>
      <div id="authStatus" class="sub" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="container">
    <div class="hero">
      <h1 class="h1">Matching 404 → 200</h1>
      <div class="sub">Onglets : Configuration, Test URL, Matching. En production, les appels passent par <code>/api/proxy</code>.</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="config">Configuration</button>
      <button class="tab" data-tab="test">Test URL</button>
      <button class="tab" data-tab="matching">Matching</button>
    </div>

    <!-- Panel: Configuration -->
    <section id="panel-config" class="tab-panel active">
      <div class="card">
        <div class="section-title">Santé API / Proxy</div>
        <div class="row">
          <div class="grow">
            <label>URL Cloud Run (dev)</label>
            <input id="apiBase" type="url" value="https://url-matcher-70649262164.europe-west1.run.app" />
            <div class="sub">En production Vercel, le proxy <code>/api/proxy</code> est utilisé automatiquement.</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:8px">
            <input id="useProxy" type="checkbox" />
            Utiliser <code>/api/proxy</code> (dev uniquement)
          </label>
          <div style="flex:1"></div>
          <button class="btn primary" id="btnHealth">Test de fonctionnement</button>
          <span id="healthBadge" class="badge">en attente…</span>
        </div>
        <div style="margin-top:10px">
          <label>Logs health</label>
          <textarea id="logsHealth" readonly></textarea>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="section-title">
          Paramètres
          <span id="prefilterBadge" class="badge info" title="Le préfiltre est actif si au moins un dictionnaire est coché dans le tableau ci-dessous.">Préfiltre : inactif</span>
        </div>
        <div class="row">
          <div class="grow">
            <label>Dictionnaire Excel (colonnes = noms de dicos, lignes = "clé, syn1, syn2…")</label>
            <input id="fileDico" type="file" accept=".xlsx,.xls" />
          </div>
          <div class="grow">
            <label>Traductions Excel (colonnes <code>SOURCE</code>, <code>TRANSLATION</code>)</label>
            <input id="fileTrad" type="file" accept=".xlsx,.xls" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="grow"><label>Parents (optionnel) – Excel avec colonne URL</label><input id="fileParents" type="file" accept=".xlsx,.xls" /></div>
        </div>

        <details style="margin-top:14px" open>
          <summary>Réglages avancés (afficher/masquer)</summary>
          <div class="row" style="margin-top:10px">
            <div class="grow"><label>Stopwords (virgules)</label><input id="inpStop" type="text" /></div>
            <div class="grow"><label>Exceptions normalisation (virgules)</label><input id="inpExc" type="text" /></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="grow"><label>Expressions multi-mots (virgules)</label><input id="inpMulti" type="text" /></div>
            <div class="grow"><label>Regex référence</label><input id="inpRegex" type="text" value="(?i)ref[:\- ]?([a-z0-9\-]+)" /></div>
            <div class="grow"><label>Score minimum (UI)</label><input id="inpMin" type="number" step="0.1" value="0.5" /></div>
          </div>

          <div style="margin-top:14px">
            <div class="section-title" style="margin-bottom:8px">Dictionnaires dynamiques</div>
            <div class="help" style="margin-bottom:8px">Réglez bonus/malus et activez le préfiltre par dico. <b title="Le bonus augmente la priorité des tokens de ce dico; le malus pénalise les tokens hors dico.">Aide bonus/malus</b></div>
            <div class="table-wrap">
              <table id="tblDico">
                <thead>
                  <tr>
                    <th>Dictionnaire</th>
                    <th style="width:130px" title="Poids positif appliqué aux tokens issus de ce dico.">Bonus</th>
                    <th style="width:130px" title="Pénalité (valeur positive) pour les tokens hors dico.">Malus</th>
                    <th style="width:120px" title="Active le préfiltre pour ce dico.">Actif</th>
                    <th style="width:140px">Entrées</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </details>

        <div style="margin-top:12px"><button class="btn ghost" id="btnApply">Appliquer</button></div>
        <div style="margin-top:12px"><label>Logs configuration</label><textarea id="logsCfg" readonly></textarea></div>
      </div>
    </section>

    <!-- Panel: Test URL -->
    <section id="panel-test" class="tab-panel">
      <div class="card">
        <div class="section-title">Test URL</div>
        <div class="row">
          <div class="grow"><label>URL</label><input id="testUrl" type="text" placeholder="https://www.exemple.com/produit/ref-AB1234?color=red"></div>
          <button class="btn primary" id="btnTest" style="align-self:flex-end">Analyser</button>
        </div>
        <div style="margin-top:10px"><label>Résultat</label><textarea id="testOut" readonly></textarea></div>
      </div>
    </section>

    <!-- Panel: Matching -->
    <section id="panel-matching" class="tab-panel">
      <div class="card">
        <div class="section-title">Matching</div>
        <div class="row">
          <div class="grow">
            <label>Fichier 404 (onglet <code>404</code>, col <code>URL_404</code>)</label>
            <input id="file404" type="file" accept=".xlsx,.xls" />
          </div>
          <div class="grow">
            <label>Fichier 200 (onglet <code>200</code>, col <code>URL_200</code>)</label>
            <input id="file200" type="file" accept=".xlsx,.xls" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn ghost" id="btnEstimate">Estimation</button>
          <div style="flex:1"></div>
          <button class="btn ghost" id="btnClear">Vider</button>
          <button class="btn primary" id="btnRun">Lancer le matching</button>
        </div>
        <div style="margin-top:12px">
          <label>Logs matching</label>
          <textarea id="logsMatch" readonly></textarea>
        </div>
      </div>
    </section>

    <div class="sub" style="margin:24px 0 40px">© URL Matcher – Vercel + Cloud Run</div>
  </div>

<script>
/* ===================== Supabase Auth + Gate ===================== */
const supabase = window.supabase.createClient(
  window.SUPABASE_URL,
  window.SUPABASE_PUBLISHABLE_KEY,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const elGate = document.getElementById('gate');
const elLoginOpen = document.getElementById('btnLoginOpen');
const elLogout = document.getElementById('btnLogout');
const elUser = document.getElementById('currentUser');

function setGateMsg(msg){ const el=document.getElementById('authStatus'); if(el) el.textContent=msg||''; }
function busy(on){ ['btnLogin','btnSignup'].forEach(id=>{const b=document.getElementById(id); if(b) b.disabled=!!on; }); }

(async function bootstrapFromHash(){
  const hash=new URLSearchParams(location.hash.slice(1));
  const access_token=hash.get('access_token'); const refresh_token=hash.get('refresh_token');
  if(access_token&&refresh_token){ try{ await supabase.auth.setSession({access_token,refresh_token}); }catch{} finally{ history.replaceState(null,'',location.pathname+location.search);} }
})();

async function applyAuthUI(){
  const { data:{ session } } = await supabase.auth.getSession();
  const authed = !!session;
  elUser.textContent = session?.user?.email ? `Connecté : ${session.user.email}` : '';
  elLogout.classList.toggle('hidden', !authed);
  elLoginOpen.classList.toggle('hidden', authed);
  elGate.classList.toggle('hidden', authed);
}

supabase.auth.onAuthStateChange((event, session)=>{
  if(event==='SIGNED_IN'){ elGate.classList.add('hidden'); elLoginOpen.classList.add('hidden'); elLogout.classList.remove('hidden'); elUser.textContent=session?.user?.email?`Connecté : ${session.user.email}`:''; }
  if(event==='SIGNED_OUT'){ elGate.classList.remove('hidden'); elLoginOpen.classList.remove('hidden'); elLogout.classList.add('hidden'); elUser.textContent=''; }
});

document.getElementById('btnLogin')?.addEventListener('click', async ()=>{
  const email=document.getElementById('authEmail').value.trim();
  const password=document.getElementById('authPassword').value;
  if(!email||!password) return setGateMsg('Renseignez email et mot de passe.');
  setGateMsg('Connexion en cours…'); busy(true);
  try{
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return setGateMsg('Erreur: '+error.message);
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session){ location.reload(); return; }
    setGateMsg('Connecté.'); await applyAuthUI();
  }catch(e){ setGateMsg('Erreur inattendue: '+(e?.message||e)); } finally{ busy(false); }
});

document.getElementById('btnSignup')?.addEventListener('click', async ()=>{
  const email=document.getElementById('authEmail').value.trim();
  const password=document.getElementById('authPassword').value;
  if(!email||!password) return setGateMsg('Renseignez email et mot de passe (min. 6 caractères).');
  setGateMsg('Création du compte…'); busy(true);
  try{
    const { error } = await supabase.auth.signUp({ email, password, options:{ emailRedirectTo: `${location.origin}/` } });
    if(error) return setGateMsg('Erreur: '+error.message);
    setGateMsg('Compte créé ✔. Vérifie ton email et clique sur le lien.');
  }catch(e){ setGateMsg('Erreur inattendue: '+(e?.message||e)); } finally{ busy(false); }
});

elLoginOpen.addEventListener('click', ()=>{ elGate.classList.remove('hidden'); });
elLogout.addEventListener('click', async ()=>{ try{ await supabase.auth.signOut(); }finally{ await applyAuthUI(); } });

applyAuthUI();
/* =================== Fin Supabase Auth + Gate =================== */


/* =================== Tabs =================== */
const tabs = document.querySelectorAll('.tab');
const panels = {
  config: document.getElementById('panel-config'),
  test: document.getElementById('panel-test'),
  matching: document.getElementById('panel-matching')
};
tabs.forEach(t=>{
  t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(panels).forEach(p=>p.classList.remove('active'));
    panels[t.dataset.tab].classList.add('active');
  });
});

/* =================== App / UI =================== */
const state={dicos:{},dicoWeights:{},translations:{},parents:[],cfg:{stop:new Set(),exc:new Set(),multi:[],ref:'(?i)ref[:\\- ]?([a-z0-9\\-]+)',min:0.5}};
function saveLocal(){localStorage.setItem('matcherFront',JSON.stringify({dicoWeights:state.dicoWeights,cfg:{stop:[...state.cfg.stop],exc:[...state.cfg.exc],multi:state.cfg.multi,ref:state.cfg.ref,min:state.cfg.min},translations:state.translations,parents:state.parents}))}
function loadLocal(){const raw=localStorage.getItem('matcherFront');if(!raw)return;try{const obj=JSON.parse(raw);state.dicoWeights=obj.dicoWeights||{};state.cfg.stop=new Set(obj?.cfg?.stop||[]);state.cfg.exc=new Set(obj?.cfg?.exc||[]);state.cfg.multi=obj?.cfg?.multi||[];state.cfg.ref=obj?.cfg?.ref||state.cfg.ref;state.cfg.min=obj?.cfg?.min??0.5;state.translations=obj.translations||{};state.parents=obj.parents||[]}catch(e){}}
loadLocal();

const apiBase=document.getElementById('apiBase');
const useProxy=document.getElementById('useProxy');
const btnHealth=document.getElementById('btnHealth');
const healthBadge=document.getElementById('healthBadge');
const logsHealth=document.getElementById('logsHealth');
const fileDico=document.getElementById('fileDico');
const fileTrad=document.getElementById('fileTrad');
const fileParents=document.getElementById('fileParents');
const inpStop=document.getElementById('inpStop');
const inpExc=document.getElementById('inpExc');
const inpMulti=document.getElementById('inpMulti');
const inpRegex=document.getElementById('inpRegex');
const inpMin=document.getElementById('inpMin');
const btnApply=document.getElementById('btnApply');
const logsCfg=document.getElementById('logsCfg');
const testUrl=document.getElementById('testUrl');
const btnTest=document.getElementById('btnTest');
const testOut=document.getElementById('testOut');
const file404=document.getElementById('file404');
const file200=document.getElementById('file200');
const btnEstimate=document.getElementById('btnEstimate');
const btnRun=document.getElementById('btnRun');
const btnClear=document.getElementById('btnClear');
const logsMatch=document.getElementById('logsMatch');
const tblDico=document.querySelector('#tblDico tbody');
const prefilterBadge=document.getElementById('prefilterBadge');

inpStop.value=[...state.cfg.stop].join(', ');
inpExc.value=[...state.cfg.exc].join(', ');
inpMulti.value=state.cfg.multi.join(', ');
inpRegex.value=state.cfg.ref;
inpMin.value=state.cfg.min;

/* Prod/Custom domain: proxy forcé + masquage du toggle (fix) */
function isLocalHost(){ const h=location.hostname; return h==='localhost'||h==='127.0.0.1'; }
function shouldUseProxy() {
  return useProxy && useProxy.checked;
}
window.addEventListener('DOMContentLoaded',()=>{
  // Ne force plus le proxy en production.
});

function buildUrl(path){
  const p = path.startsWith('/') ? path : '/' + path;
  if (shouldUseProxy()) return location.origin + '/api/proxy?path=' + encodeURIComponent(p);
  return apiBase.value.replace(/\/$/, '') + p;
}

/* Health */
function hlog(m){ logsHealth.value+=(logsHealth.value?'\n':'')+m; logsHealth.scrollTop=logsHealth.scrollHeight; }
async function tryProbe(probe, timeoutMs=5000){
  const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),timeoutMs);
  const init={method:probe.method,signal:controller.signal,headers:probe.headers||{},redirect:'manual'};
  if('body' in probe) init.body=probe.body;
  const url=buildUrl(probe.path); const started=Date.now();
  try{ const resp=await fetch(url,init); const ms=Date.now()-started; const ok=probe.okStatuses.includes(resp.status)||(resp.ok&&probe.okStatuses.includes(200)); return {ok,status:resp.status,ms,url}; }
  catch(err){ const ms=Date.now()-started; return {ok:false,error:String(err),ms,url}; }
  finally{ clearTimeout(t); }
}
const HEALTH_PROBES=[
  {name:'GET /',             path:'/',             method:'GET',     okStatuses:[200,204]},
  {name:'HEAD /',            path:'/',             method:'HEAD',    okStatuses:[200,204]},
  {name:'GET /openapi.json', path:'/openapi.json', method:'GET',     okStatuses:[200]},
  {name:'OPTIONS /match',    path:'/match',        method:'OPTIONS', okStatuses:[200,204]},
  {name:'POST /match (empty)', path:'/match',      method:'POST',    okStatuses:[200,204,400,415,422]}
];
btnHealth.addEventListener('click', async ()=>{
  healthBadge.textContent='test…';
  healthBadge.className='badge';
  logsHealth.value='';

  // on exécute TOUTES les sondes, on n'arrête pas au premier succès
  let allOk = true;

  for (const probe of HEALTH_PROBES) {
    const r = await tryProbe(probe);
    if (r.ok) {
      hlog(`✅ ${probe.name} → ${r.status} (${r.ms}ms) via ${r.url}`);
    } else {
      allOk = false;
      hlog(`❌ ${probe.name} → ${r.status || 'ERR'} (${r.ms}ms) via ${r.url}${r.error ? (' | ' + r.error) : ''}`);
    }
  }

  if (allOk) {
    healthBadge.textContent = 'OK';
    healthBadge.className = 'badge ok';
  } else {
    healthBadge.textContent = 'ERREUR';
    healthBadge.className = 'badge err';
  }
});


/* =================== Fonctionnalités type moteur (UI) =================== */
function normalizeText(s){ if(!s) return ''; return String(s).toLowerCase().replace(/\s+/g,' ').trim(); }
function cleanAndNormalizeUrl(url){ if(!url) return ''; let u=String(url).toLowerCase(); u=u.replace(/^https?:\/\//,''); u=u.replace(/^www\./,''); u=u.replace(/[-_\/?&=]+/g,' '); // exceptions: placeholder si logique fine nécessaire
  return normalizeText(u); }
function applyMultiWords(text){ let t=text; state.cfg.multi.forEach(exp=>{ if(!exp) return; const r=new RegExp(exp.replace(/[-\s]+/g,'\\s+'),'gi'); t=t.replace(r,exp.replace(/\s+/g,'-')); }); return t; }
function getTokensFromText(text){ let tokens=text.split(/\s+/).filter(Boolean); tokens=tokens.filter(tok=>!state.cfg.stop.has(tok)); tokens=tokens.map(tok=>state.translations[tok]||tok); return tokens; }
function reduceByActiveDictionaries(tokens){ const active=Object.keys(state.dicos).filter(n=>(state.dicoWeights[n]||{active:true}).active); return tokens.map(tok=>{ for(const name of active){ const dict=state.dicos[name]; for(const key in dict){ if(dict[key].has(tok)||key===tok) return key; } } return tok; }); }
function applySynonymSubstitution(rawUrl){ const clean=cleanAndNormalizeUrl(rawUrl); const mw=applyMultiWords(clean); const t1=getTokensFromText(mw); const t2=reduceByActiveDictionaries(t1); return { clean, substituted:t2.join(' '), tokens:t2 }; }
function extractRefFromUrl(url){ try{ const m=new RegExp(state.cfg.ref).exec(url); return m?m[1]:null; }catch(e){ return null; } }
function detectCharacteristics(substitutedText){ const hitsByDico={}; const active=Object.keys(state.dicos).filter(n=>(state.dicoWeights[n]||{active:true}).active); const tokens=substitutedText.split(/\s+/).filter(Boolean); active.forEach(name=>{ const dict=state.dicos[name]; const hits=new Set(); tokens.forEach(tok=>{ for(const key in dict){ if(dict[key].has(tok)||key===tok) hits.add(key); } }); hitsByDico[name]=[...hits]; }); return hitsByDico; }

/* ===== Helper: sérialiser la config UI pour l'envoyer au backend ===== */
function buildConfigFromUI(){
  const dictionaries = Object.entries(state.dicos).map(([name, dict]) => ({
    name,
    rows: Object.entries(dict).map(([k, synSet]) => [k, ...Array.from(synSet)].join(','))
  }));
  const bonus = {}, malus = {}, prefilter = {};
  Object.entries(state.dicoWeights || {}).forEach(([name, w]) => {
    bonus[name] = Number(w?.bonus || 0);
    malus[name] = Number(w?.malus || 0);
    prefilter[name] = !!w?.active;
  });
  return {
    stopwords: [...state.cfg.stop],
    exceptions: [...state.cfg.exc],
    multi: state.cfg.multi,
    refRegex: state.cfg.ref,
    translations: Object.entries(state.translations || {}).map(([SOURCE, TRANSLATION]) => ({ SOURCE, TRANSLATION })),
    dictionaries,
    bonus,
    malus,
    prefilter,
    scoreMin: state.cfg.min,
    parents: state.parents || []
  };
}

/* Dico table rendering + badge */
function updatePrefilterBadge(){ const active=Object.keys(state.dicoWeights).filter(n=> (state.dicoWeights[n]||{}).active); if(active.length>0){ prefilterBadge.textContent='Préfiltre : actif'; prefilterBadge.className='badge ok'; prefilterBadge.title='Au moins un dictionnaire actif : le préfiltre est appliqué.'; } else { prefilterBadge.textContent='Préfiltre : inactif'; prefilterBadge.className='badge info'; prefilterBadge.title='Activez un dictionnaire pour activer le préfiltre.'; } }
function renderDicoTable(){ if(!tblDico) return; tblDico.innerHTML=''; const names=Object.keys(state.dicos); if(names.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.textContent='Aucun dictionnaire chargé.'; td.style.color='var(--muted)'; tr.appendChild(td); tblDico.appendChild(tr); updatePrefilterBadge(); return; } names.forEach(name=>{ const dict=state.dicos[name]; const w=state.dicoWeights[name]||{bonus:1,malus:1,active:true}; const entries=Object.keys(dict).length; const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${name}</td>
      <td><input type="number" step="0.1" value="${w.bonus}" data-k="bonus" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff" title="Bonus: augmente l'influence des tokens de ce dico."></td>
      <td><input type="number" step="0.1" value="${w.malus}" data-k="malus" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff" title="Malus: pénalise les tokens hors dico (valeur positive affichée)."></td>
      <td><input class="switch" type="checkbox" ${w.active?'checked':''} data-k="active" title="Activer/Désactiver le préfiltre pour ce dico."></td>
      <td>${entries.toLocaleString('fr-FR')}</td>
    `; tr.querySelectorAll('input').forEach(inp=>{ inp.addEventListener('change',()=>{ const key=inp.dataset.k; const row=state.dicoWeights[name]||{bonus:1,malus:1,active:true}; if(key==='active') row.active=inp.checked; else row[key]=Number(inp.value); state.dicoWeights[name]=row; saveLocal(); updatePrefilterBadge(); }); }); tblDico.appendChild(tr); }); updatePrefilterBadge(); }
renderDicoTable();

/* Config save */
btnApply.addEventListener('click',()=>{
  state.cfg.stop=new Set(inpStop.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));
  state.cfg.exc=new Set(inpExc.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));
  state.cfg.multi=inpMulti.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  state.cfg.ref=inpRegex.value.trim()||state.cfg.ref;
  state.cfg.min=Number(inpMin.value)||0.5;
  saveLocal();
  logsCfg.value+=(logsCfg.value?'\n':'')+'[CONFIG] Paramètres appliqués.';
});

/* Excel readers */
async function readExcel(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});resolve(wb)}catch(err){reject(err)}};reader.onerror=reject;reader.readAsArrayBuffer(file)});} 

fileDico.addEventListener('change',async()=>{logsCfg.value='';if(!fileDico.files[0])return;try{const wb=await readExcel(fileDico.files[0]);state.dicos={};wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const df=XLSX.utils.sheet_to_json(sh,{header:1,blankrows:false});if(df.length===0)return;const cols=df[0].map((_,i)=>df.map(row=>row[i]));cols.forEach((col,idx)=>{const dicoName=String(df[0][idx]||`Dico_${idx+1}`);if(!state.dicos[dicoName])state.dicos[dicoName]={};for(let r=1;r<col.length;r++){const cell=col[r];if(cell==null)continue;const items=String(cell).split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);if(items.length===0)continue;const key=items[0];state.dicos[dicoName][key]=(state.dicos[dicoName][key]||new Set());items.forEach(x=>state.dicos[dicoName][key].add(x))}})});saveLocal();renderDicoTable();logsCfg.value=`[DICO] ${Object.keys(state.dicos).length} dictionnaire(s) chargé(s).`}catch(e){logsCfg.value='[DICO][ERREUR] '+e.message}});

fileTrad.addEventListener('change',async()=>{if(!fileTrad.files[0])return;try{const wb=await readExcel(fileTrad.files[0]);state.translations={};wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const arr=XLSX.utils.sheet_to_json(sh);arr.forEach(row=>{const s=String(row['SOURCE']||'').trim().toLowerCase();const t=String(row['TRANSLATION']||'').trim().toLowerCase();if(s)state.translations[s]=t})});saveLocal();logsCfg.value=`[TRAD] ${Object.keys(state.translations).length} entrées.`}catch(e){logsCfg.value='[TRAD][ERREUR] '+e.message}});

fileParents.addEventListener('change',async()=>{if(!fileParents.files[0])return;try{const wb=await readExcel(fileParents.files[0]);state.parents=[];wb.SheetNames.forEach(name=>{const sh=wb.Sheets[name];const arr=XLSX.utils.sheet_to_json(sh);arr.forEach(row=>{if(row.URL)state.parents.push(String(row.URL))})});saveLocal();logsCfg.value=`[PARENTS] ${state.parents.length} URLs.`}catch(e){logsCfg.value='[PARENTS][ERREUR] '+e.message}});

/* Test URL → appelle le backend /debug-url avec la config */
btnTest.addEventListener('click', async () => {
  const url = testUrl.value.trim();
  if(!url){ testOut.value = 'Veuillez saisir une URL.'; return; }
  try{
    const payload = { url, config: buildConfigFromUI() };
    const r = await fetch(buildUrl('/debug_url'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('HTTP '+r.status+' – '+await r.text()); }
    const j = await r.json();
    const out = [];
    out.push(`URL brute : ${j.input}`);
    out.push('URL nettoyée :');
    out.push(' → ' + j.clean);
    out.push('Après synonymes :');
    out.push(' → ' + j.substituted);
    out.push('Tokens :');
    out.push(j.tokens?.length ? (' → ' + j.tokens.join(', ')) : ' → Aucun token');
    out.push(j.reference ? `Référence détectée : ${j.reference}` : 'Aucune référence détectée via la regex.');
    out.push('Caractéristiques détectées :');
    const dicos = Object.keys(j.dico_hits || {});
    if(!dicos.length){ out.push(' → Aucun dictionnaire.'); }
    else {
      dicos.forEach(name => {
        const keys = j.dico_hits[name] || [];
        out.push(keys.length ? ` [${name}] → ${keys.join(', ')}` : ` [${name}] → aucune`);
      });
    }
    testOut.value = out.join('\n');
  }catch(e){
    testOut.value = '[ERREUR] ' + (e?.message || String(e));
  }
});

/* Matching */
btnEstimate.addEventListener('click',async()=>{logsMatch.value='';if(!file404.files[0]||!file200.files[0]){logsMatch.value='Charge les deux fichiers d\'abord.';return}try{const wb404=await readExcel(file404.files[0]);const sh404=wb404.Sheets['404']||wb404.Sheets[wb404.SheetNames[0]];const arr404=XLSX.utils.sheet_to_json(sh404);const wb200=await readExcel(file200.files[0]);const sh200=wb200.Sheets['200']||wb200.Sheets[wb200.SheetNames[0]];const arr200=XLSX.utils.sheet_to_json(sh200);if(arr404.length===0||arr200.length===0){logsMatch.value='[ESTIMATION] Fichiers vides.';return}const total=arr404.length;const est=(0.035+0.025)*total;const min=(est/60).toFixed(1);logsMatch.value=`[ESTIMATION] ~ ${min} minutes (approx).`}catch(e){logsMatch.value='[ESTIMATION][ERREUR] '+e.message}});
btnClear.addEventListener('click',()=>{logsMatch.value='';file404.value='';file200.value=''});
btnRun.addEventListener('click',async()=>{logsMatch.value='';if(!file404.files[0]||!file200.files[0]){logsMatch.value='Upload les fichiers d\'abord.';return}try{const form=new FormData();form.append('file404',file404.files[0]);form.append('file200',file200.files[0]);form.append('config', JSON.stringify(buildConfigFromUI()));logsMatch.value='[0%] Upload en cours…';const { data:{ session } }=await supabase.auth.getSession();const token=session?.access_token||null;const headers={};if(token) headers['Authorization']=`Bearer ${token}`;const r=await fetch(buildUrl('/match'),{method:'POST',headers,body:form});if(!r.ok){const txt=await r.text();throw new Error('HTTP '+r.status+' – '+txt)}logsMatch.value+=' \n[60%] Traitement côté API…';const blob=await r.blob();logsMatch.value+=' \n[90%] Réception du résultat…';const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='result.xlsx';document.body.appendChild(a);a.click();a.remove();logsMatch.value+=' \n[100%] Terminé. Fichier téléchargé : result.xlsx'}catch(e){logsMatch.value='[ERREUR] '+e.message}});
</script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>URL Matcher</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#5f6b7a; --border:#e5e7eb;
      --accent:#2563eb; --accent-600:#1d4ed8; --ok:#16a34a; --err:#dc2626; --chip:#eef2ff
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:60px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{width:10px;height:24px;background:var(--accent);border-radius:4px}
    .actions{display:flex;align-items:center;gap:10px}
    .user{font-size:14px;color:var(--muted)}
    .btn{cursor:pointer;border:none;border-radius:10px;font-weight:600;padding:10px 14px}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-600)}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn.ghost:hover{background:#fafafa}
    .btn.mini{padding:8px 10px;border-radius:10px;font-size:13px}
    .hidden{display:none !important}

    /* Hero */
    .hero{padding:24px 0 12px}
    .h1{font-size:24px;font-weight:800;margin:0}
    .sub{margin-top:6px;color:var(--muted);line-height:1.4}

    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);padding-bottom:8px;margin:18px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;background:var(--chip);color:#1e3a8a;cursor:pointer;border:1px solid var(--border)}
    .tab.active{background:var(--accent);color:#fff}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* Cards / form */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 8px 24px #0000000a}
    .section-title{font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;gap:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    input[type=text],input[type=url],input[type=number],input[type=email],input[type=password],textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fafafa;color:var(--text)
    }
    input[type=file]{width:100%}
    textarea{min-height:110px;white-space:pre-wrap}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.ok{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
    .badge.err{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .badge.info{background:#eff6ff;color:#1e3a8a;border-color:#bfdbfe}

    /* Auth gate */
    #gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#eef2f7;z-index:50}
    #gate .card{width:520px}

    /* Table dictionnaires + tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:13px;color:var(--muted);font-weight:600}
    .switch{appearance:none;width:42px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;outline:none;cursor:pointer;transition:.2s}
    .switch:checked{background:var(--accent)}
    .switch:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:.2s;box-shadow:0 1px 3px #0001}
    .switch:checked:before{left:21px}
    details{background:#fafafa;border:1px solid var(--border);border-radius:10px;padding:10px}
    summary{cursor:pointer;font-weight:600}
    .help{font-size:12px;color:var(--muted)}

    /* ================== Run Summary (PRO) ================== */
    #runSummaryModal.hidden{display:none !important;}
    #runSummaryModal{position:fixed;inset:0;z-index:80;}
    .rs-backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45);}
    .rs-modal{
      position:relative;
      width:min(760px, calc(100% - 28px));
      margin:60px auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 30px 80px #00000033;
      overflow:hidden;
    }
    .rs-header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:16px 16px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.9);
    }
    .rs-title{font-weight:800;font-size:18px;margin:0;color:var(--text)}
    .rs-subtitle{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.35}
    .rs-body{padding:16px;display:grid;gap:12px;}
    .rs-kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;}
    @media (max-width:720px){ .rs-kpis{grid-template-columns:1fr;} }
    .rs-kpi{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fafafa;
    }
    .rs-kpi .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .rs-kpi .value{font-size:20px;font-weight:800;color:var(--text);line-height:1}
    .rs-kpi .hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .rs-callout{
      border:1px solid #bfdbfe;
      background:#eff6ff;
      color:#1e3a8a;
      border-radius:12px;
      padding:12px;
      font-size:13px;
      line-height:1.35;
    }
    .rs-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .rs-table th, .rs-table td{
      padding:10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .rs-table th{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      background:#fafafa;
    }
    .rs-table tr:last-child td{border-bottom:none;}
    .rs-url{
      word-break:break-word;
      color:var(--text);
      font-size:12px;
      line-height:1.35;
    }
    .rs-footer{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      padding:14px 16px;
      border-top:1px solid var(--border);
      background:#fff;
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    window.SUPABASE_URL="https://srvvdrhiaygklqjijdtq.supabase.co";
    window.SUPABASE_PUBLISHABLE_KEY="sb_publishable_Tm5K5o-Fq_UBHP9Qp6JBog_rtKQjpDi";
  </script>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container nav">
      <div class="brand">
        <div class="logo"></div><span>URL&nbsp;Matcher</span>
      </div>
      <div class="actions">
        <span id="currentUser" class="user"></span>
        <button id="btnLoginOpen" class="btn primary">Se connecter</button>

        <!-- Historique en haut à droite (uniquement connecté) -->
        <button id="btnHistoryTop" class="btn ghost hidden">Historique</button>

        <button id="btnLogout" class="btn ghost hidden">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- Auth Gate -->
  <div id="gate" class="hidden">
    <div class="card">
      <div class="section-title" style="font-size:18px">Connexion</div>
      <div class="row" style="margin-top:6px">
        <div class="grow"><label>Email</label><input id="authEmail" type="email" placeholder="you@domain.tld"></div>
        <div class="grow"><label>Mot de passe</label><input id="authPassword" type="password" placeholder="••••••••"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnLogin">Se connecter</button>
        <button class="btn ghost" id="btnSignup">Créer un compte</button>
        <button class="btn ghost" id="btnGateClose" type="button">Fermer</button>
      </div>
      <div id="authStatus" class="sub" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="container">
    <div class="hero">
      <h1 class="h1">Redirections 404 → 200</h1>
      <div class="sub">
        Importez vos fichiers 404/200, appliquez vos règles (dictionnaires, traductions, regex), puis exportez un fichier de résultat prêt à l’emploi.
      </div>
    </div>

    <!-- Tabs (Historique supprimé ici : uniquement bouton en topbar) -->
    <div class="tabs">
      <button class="tab active" data-tab="config">Paramètres</button>
      <button class="tab" data-tab="test">Diagnostic URL</button>
      <button class="tab" data-tab="matching">Traitement</button>
    </div>

    <!-- Panel: Configuration -->
    <section id="panel-config" class="tab-panel active">
      <div class="card">
        <div class="section-title">
          Paramètres
          <span id="prefilterBadge" class="badge info" title="Le préfiltre est actif si au moins un dictionnaire est coché dans le tableau ci-dessous.">Préfiltre : inactif</span>
        </div>

        <div class="row">
          <div class="grow">
            <label>Dictionnaire Excel (colonnes = noms de dicos, lignes = "clé, syn1, syn2…")</label>
            <input id="fileDico" type="file" accept=".xlsx,.xls" />
          </div>
          <div class="grow">
            <label>Traductions Excel (colonnes <code>SOURCE</code>, <code>TRANSLATION</code>)</label>
            <input id="fileTrad" type="file" accept=".xlsx,.xls" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="grow"><label>Parents (optionnel) – Excel avec colonne URL</label><input id="fileParents" type="file" accept=".xlsx,.xls" /></div>
        </div>

        <details style="margin-top:14px" open>
          <summary>Réglages avancés</summary>

          <div class="row" style="margin-top:10px">
            <div class="grow"><label>Stopwords (virgules)</label><input id="inpStop" type="text" /></div>
            <div class="grow"><label>Exceptions normalisation (virgules)</label><input id="inpExc" type="text" /></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="grow"><label>Expressions multi-mots (virgules)</label><input id="inpMulti" type="text" /></div>
            <div class="grow"><label>Regex référence</label><input id="inpRegex" type="text" value="(?i)ref[:\- ]?([a-z0-9\-]+)" /></div>
            <div class="grow"><label>Score minimum</label><input id="inpMin" type="number" step="0.1" value="0.5" /></div>
          </div>

          <div style="margin-top:14px">
            <div class="section-title" style="margin-bottom:8px">Dictionnaires dynamiques</div>
            <div class="help" style="margin-bottom:8px">Réglez bonus/malus et activez le préfiltre par dictionnaire.</div>

            <div class="table-wrap">
              <table id="tblDico">
                <thead>
                  <tr>
                    <th>Dictionnaire</th>
                    <th style="width:130px">Bonus</th>
                    <th style="width:130px">Malus</th>
                    <th style="width:120px">Actif</th>
                    <th style="width:140px">Entrées</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </details>

        <div style="margin-top:12px"><button class="btn ghost" id="btnApply">Appliquer</button></div>
        <div style="margin-top:12px"><label>Journal</label><textarea id="logsCfg" readonly></textarea></div>
      </div>
    </section>

    <!-- Panel: Test URL -->
    <section id="panel-test" class="tab-panel">
      <div class="card">
        <div class="section-title">Diagnostic URL</div>
        <div class="row">
          <div class="grow"><label>URL</label><input id="testUrl" type="text" placeholder="https://www.exemple.com/produit/ref-AB1234?color=red"></div>
          <button class="btn primary" id="btnTest" style="align-self:flex-end">Analyser</button>
        </div>
        <div style="margin-top:10px"><label>Résultat</label><textarea id="testOut" readonly></textarea></div>
      </div>
    </section>

    <!-- Panel: Matching -->
    <section id="panel-matching" class="tab-panel">
      <div class="card">
        <div class="section-title">Traitement</div>

        <div class="row">
          <div class="grow">
            <label>Fichier 404 (onglet <code>404</code>, col <code>URL_404</code>)</label>
            <input id="file404" type="file" accept=".xlsx,.xls" />
          </div>
          <div class="grow">
            <label>Fichier 200 (onglet <code>200</code>, col <code>URL_200</code>)</label>
            <input id="file200" type="file" accept=".xlsx,.xls" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1"></div>
          <button class="btn ghost" id="btnClear">Réinitialiser</button>
          <button class="btn primary" id="btnRun">Lancer le traitement</button>
        </div>

        <div style="margin-top:12px">
          <label>Journal d’exécution</label>
          <textarea id="logsMatch" readonly></textarea>
        </div>

        <!-- Progress -->
        <div id="progressWrap" class="card" style="margin-top:12px;background:#fafafa">
          <div class="row" style="align-items:center">
            <div class="grow">
              <div class="section-title" style="margin:0">Progression</div>
              <div id="matchMeta" class="sub">En attente…</div>
            </div>
            <span id="matchStatus" class="badge info">idle</span>
          </div>

          <div style="margin-top:10px;border:1px solid var(--border);border-radius:999px;background:#fff;overflow:hidden;height:12px">
            <div id="matchBar" style="height:12px;width:0%;background:var(--accent);transition:width .25s ease"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <span class="help">Temps écoulé : <b id="matchElapsed">0:00</b></span>
            <div style="flex:1"></div>
            <span class="help" id="matchHint"></span>
          </div>
        </div>

        <!-- Download -->
        <div id="downloadWrap" class="hidden" style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="btn primary" id="btnDownload" type="button">Télécharger le résultat</button>
          <span id="downloadLabel" class="sub"></span>
        </div>

      </div>
    </section>

    <!-- Panel: Historique (accessible via bouton topbar) -->
    <section id="panel-history" class="tab-panel">
      <div class="card">
        <div class="section-title" style="justify-content:space-between;align-items:center;">
          <span>Historique</span>
          <button class="btn ghost mini" id="btnHistoryRefresh" type="button">Rafraîchir</button>
        </div>
        <div class="sub">Chaque run est stocké dans Storage. Tu peux retélécharger le résultat et (si présents) les fichiers importés.</div>

        <div style="margin-top:12px;overflow:auto">
          <table id="tblHistory">
            <thead>
              <tr>
                <th style="width:220px">Date</th>
                <th style="width:260px">Nom</th>
                <th>Run</th>
                <th style="width:360px">Fichiers</th>
                <th style="width:340px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="historyStatus" class="sub" style="margin-top:10px"></div>
      </div>
    </section>

    <div class="sub" style="margin:24px 0 40px">© Tigui Camara</div>
  </div>

  <!-- Run Summary Modal (PRO) -->
  <div id="runSummaryModal" class="hidden">
    <div class="rs-backdrop" id="runSummaryBackdrop"></div>

    <div class="rs-modal" role="dialog" aria-modal="true" aria-labelledby="rsTitle">
      <div class="rs-header">
        <div>
          <div id="rsTitle" class="rs-title">Récap du run</div>
          <div id="rsSubtitle" class="rs-subtitle"></div>
        </div>
        <button id="btnRunSummaryClose" class="btn ghost" type="button">Fermer</button>
      </div>

      <div class="rs-body" id="runSummaryContent"></div>

      <div class="rs-footer">
        <button id="btnRunSummaryDownload" class="btn primary" type="button">Télécharger le résultat</button>
        <button id="btnRunSummaryOk" class="btn ghost" type="button">OK</button>
      </div>
    </div>
  </div>

<script>
/* ===================== Supabase Auth + Gate ===================== */
const supabaseClient = window.supabase.createClient(
  window.SUPABASE_URL,
  window.SUPABASE_PUBLISHABLE_KEY,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);

const elGate = document.getElementById('gate');
const elLoginOpen = document.getElementById('btnLoginOpen');
const elLogout = document.getElementById('btnLogout');
const elUser = document.getElementById('currentUser');
const elHistoryTop = document.getElementById('btnHistoryTop');

function setGateMsg(msg){ const el=document.getElementById('authStatus'); if(el) el.textContent=msg||''; }
function busy(on){ ['btnLogin','btnSignup'].forEach(id=>{const b=document.getElementById(id); if(b) b.disabled=!!on; }); }

(async function bootstrapFromHash(){
  const hash=new URLSearchParams(location.hash.slice(1));
  const access_token=hash.get('access_token'); const refresh_token=hash.get('refresh_token');
  if(access_token&&refresh_token){
    try{ await supabaseClient.auth.setSession({access_token,refresh_token}); }
    catch{}
    finally{ history.replaceState(null,'',location.pathname+location.search); }
  }
})();

async function requireAuthOrGate(message){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){
    setGateMsg(message || 'Connecte-toi pour continuer.');
    elGate.classList.remove('hidden');
    return null;
  }
  return session;
}

async function applyAuthUI(){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  const authed = !!session;

  elUser.textContent = session?.user?.email ? `Connecté : ${session.user.email}` : '';
  elLogout.classList.toggle('hidden', !authed);
  elLoginOpen.classList.toggle('hidden', authed);
  elHistoryTop.classList.toggle('hidden', !authed);

  elGate.classList.add('hidden');

  if(!authed){
    renderHistoryEmpty('Connecte-toi pour voir ton historique.');
  }
}

supabaseClient.auth.onAuthStateChange((event, session)=>{
  if(event==='SIGNED_IN'){
    elGate.classList.add('hidden');
    elLoginOpen.classList.add('hidden');
    elLogout.classList.remove('hidden');
    elHistoryTop.classList.remove('hidden');
    elUser.textContent = session?.user?.email ? `Connecté : ${session.user.email}` : '';
  }
  if(event==='SIGNED_OUT'){
    elGate.classList.add('hidden');
    elLoginOpen.classList.remove('hidden');
    elLogout.classList.add('hidden');
    elHistoryTop.classList.add('hidden');
    elUser.textContent = '';
    renderHistoryEmpty('Connecte-toi pour voir ton historique.');
  }
});

document.getElementById('btnLogin')?.addEventListener('click', async ()=>{
  const email=document.getElementById('authEmail').value.trim();
  const password=document.getElementById('authPassword').value;
  if(!email||!password) return setGateMsg('Renseignez email et mot de passe.');
  setGateMsg('Connexion en cours…'); busy(true);
  try{
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if(error) return setGateMsg('Erreur: '+error.message);
    const { data:{ session } } = await supabaseClient.auth.getSession();
    if(!session){ location.reload(); return; }
    setGateMsg('Connecté.'); await applyAuthUI();
  }catch(e){ setGateMsg('Erreur inattendue: '+(e?.message||e)); }
  finally{ busy(false); }
});

document.getElementById('btnSignup')?.addEventListener('click', async ()=>{
  const email=document.getElementById('authEmail').value.trim();
  const password=document.getElementById('authPassword').value;
  if(!email||!password) return setGateMsg('Renseignez email et mot de passe (min. 6 caractères).');
  setGateMsg('Création du compte…'); busy(true);
  try{
    const { error } = await supabaseClient.auth.signUp({ email, password, options:{ emailRedirectTo: `${location.origin}/` } });
    if(error) return setGateMsg('Erreur: '+error.message);
    setGateMsg('Compte créé ✔. Vérifie ton email et clique sur le lien.');
  }catch(e){ setGateMsg('Erreur inattendue: '+(e?.message||e)); }
  finally{ busy(false); }
});

elLoginOpen.addEventListener('click', ()=>{
  setGateMsg('');
  elGate.classList.remove('hidden');
});
document.getElementById('btnGateClose')?.addEventListener('click', ()=>{
  elGate.classList.add('hidden');
});
elLogout.addEventListener('click', async ()=>{
  try{ await supabaseClient.auth.signOut(); }
  finally{ await applyAuthUI(); }
});

applyAuthUI();
/* =================== Fin Supabase Auth + Gate =================== */


/* =================== Tabs & Panels =================== */
const tabs = document.querySelectorAll('.tab');
const panels = {
  config: document.getElementById('panel-config'),
  test: document.getElementById('panel-test'),
  matching: document.getElementById('panel-matching'),
  history: document.getElementById('panel-history')
};

function openPanel(name){
  Object.values(panels).forEach(p=>p.classList.remove('active'));
  if(panels[name]) panels[name].classList.add('active');

  // highlight uniquement si on a un tab pour ce panel
  tabs.forEach(x=>x.classList.remove('active'));
  const btn = document.querySelector(`.tab[data-tab="${name}"]`);
  if(btn) btn.classList.add('active');

  if(name === 'history'){
    loadHistory().catch(()=>{});
  }
}

tabs.forEach(t=>{
  t.addEventListener('click',()=>openPanel(t.dataset.tab));
});

// Bouton topbar Historique (seulement connecté)
elHistoryTop?.addEventListener('click', async ()=>{
  const session = await requireAuthOrGate('Connecte-toi pour accéder à ton historique.');
  if(!session) return;
  openPanel('history');
});

/* =================== App / UI =================== */
const state={dicos:{},dicoWeights:{},translations:{},parents:[],cfg:{stop:new Set(),exc:new Set(),multi:[],ref:'(?i)ref[:\\- ]?([a-z0-9\\-]+)',min:0.5}};
function saveLocal(){localStorage.setItem('matcherFront',JSON.stringify({dicoWeights:state.dicoWeights,cfg:{stop:[...state.cfg.stop],exc:[...state.cfg.exc],multi:state.cfg.multi,ref:state.cfg.ref,min:state.cfg.min},translations:state.translations,parents:state.parents}))}
function loadLocal(){const raw=localStorage.getItem('matcherFront');if(!raw)return;try{const obj=JSON.parse(raw);state.dicoWeights=obj.dicoWeights||{};state.cfg.stop=new Set(obj?.cfg?.stop||[]);state.cfg.exc=new Set(obj?.cfg?.exc||[]);state.cfg.multi=obj?.cfg?.multi||[];state.cfg.ref=obj?.cfg?.ref||state.cfg.ref;state.cfg.min=obj?.cfg?.min??0.5;state.translations=obj.translations||{};state.parents=obj.parents||[]}catch(e){}}
loadLocal();

/* DOM */
const fileDico=document.getElementById('fileDico');
const fileTrad=document.getElementById('fileTrad');
const fileParents=document.getElementById('fileParents');
const inpStop=document.getElementById('inpStop');
const inpExc=document.getElementById('inpExc');
const inpMulti=document.getElementById('inpMulti');
const inpRegex=document.getElementById('inpRegex');
const inpMin=document.getElementById('inpMin');
const btnApply=document.getElementById('btnApply');
const logsCfg=document.getElementById('logsCfg');

const testUrl=document.getElementById('testUrl');
const btnTest=document.getElementById('btnTest');
const testOut=document.getElementById('testOut');

const file404=document.getElementById('file404');
const file200=document.getElementById('file200');
const btnRun=document.getElementById('btnRun');
const btnClear=document.getElementById('btnClear');
const logsMatch=document.getElementById('logsMatch');

const tblDico=document.querySelector('#tblDico tbody');
const prefilterBadge=document.getElementById('prefilterBadge');

/* Progress UI */
const matchBar = document.getElementById('matchBar');
const matchMeta = document.getElementById('matchMeta');
const matchStatus = document.getElementById('matchStatus');
const matchElapsed = document.getElementById('matchElapsed');
const matchHint = document.getElementById('matchHint');

/* Téléchargement immédiat (blob local) */
const downloadWrap = document.getElementById('downloadWrap');
const btnDownload = document.getElementById('btnDownload');
const downloadLabel = document.getElementById('downloadLabel');

let resultBlobUrl = null;
let resultFilename = 'result.xlsx';

function resetDownloadUI() {
  if (resultBlobUrl) {
    URL.revokeObjectURL(resultBlobUrl);
    resultBlobUrl = null;
  }
  resultFilename = 'result.xlsx';
  downloadWrap.classList.add('hidden');
  downloadLabel.textContent = '';
}

btnDownload.addEventListener('click', () => {
  if (!resultBlobUrl) return;
  const a = document.createElement('a');
  a.href = resultBlobUrl;
  a.download = resultFilename || 'result.xlsx';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* Init inputs */
inpStop.value=[...state.cfg.stop].join(', ');
inpExc.value=[...state.cfg.exc].join(', ');
inpMulti.value=state.cfg.multi.join(', ');
inpRegex.value=state.cfg.ref;
inpMin.value=state.cfg.min;

/* URL builder */
const DEV_API_BASE = "https://url-matcher-70649262164.europe-west1.run.app";
function isLocalHost(){
  const h = location.hostname;
  return h === 'localhost' || h === '127.0.0.1';
}
function buildUrl(path){
  const p = path.startsWith('/') ? path : '/' + path;
  if (!isLocalHost()) return location.origin + '/api/proxy?path=' + encodeURIComponent(p);
  return DEV_API_BASE.replace(/\/$/, '') + p;
}

/* =================== Supabase Storage helpers =================== */
const STORAGE_BUCKET = 'matcher-results';

function tsForRunId(){
  const iso = new Date().toISOString();
  return iso.slice(0,19).replace('T','_').replace(/:/g,'-');
}
function rand4(){ return Math.random().toString(16).slice(2,6); }
function makeRunId(){ return `${tsForRunId()}_${rand4()}`; }
function excelContentType(){ return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; }
function extFromFile(file){
  const n = (file?.name || '').toLowerCase();
  if(n.endsWith('.xlsx')) return 'xlsx';
  if(n.endsWith('.xls')) return 'xls';
  return 'xlsx';
}
function prettyRunDate(runId){
  const parts = String(runId || '').split('_');
  if(parts.length < 2) return runId;
  const d = parts[0];
  const t = parts[1].replace(/-/g,':');
  return `${d} ${t}`;
}
async function storageSignedDownload(path, suggestedName){
  const { data, error } = await supabaseClient.storage
    .from(STORAGE_BUCKET)
    .createSignedUrl(path, 60);
  if(error) throw error;

  const a = document.createElement('a');
  a.href = data.signedUrl;
  a.download = suggestedName || path.split('/').pop();
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function uploadRunFolder({ userId, runId, resultBlob, dicoFile, tradFile, parentsFile }){
  const base = `${userId}/runs/${runId}`;

  const up1 = await supabaseClient.storage
    .from(STORAGE_BUCKET)
    .upload(`${base}/result.xlsx`, resultBlob, { contentType: excelContentType(), upsert: false });

  if(up1.error) throw up1.error;

  const uploads = [];

  if(dicoFile){
    const ext = extFromFile(dicoFile);
    uploads.push(
      supabaseClient.storage.from(STORAGE_BUCKET).upload(
        `${base}/dico.${ext}`, dicoFile,
        { contentType: dicoFile.type || excelContentType(), upsert: false }
      )
    );
  }
  if(tradFile){
    const ext = extFromFile(tradFile);
    uploads.push(
      supabaseClient.storage.from(STORAGE_BUCKET).upload(
        `${base}/trad.${ext}`, tradFile,
        { contentType: tradFile.type || excelContentType(), upsert: false }
      )
    );
  }
  if(parentsFile){
    const ext = extFromFile(parentsFile);
    uploads.push(
      supabaseClient.storage.from(STORAGE_BUCKET).upload(
        `${base}/parents.${ext}`, parentsFile,
        { contentType: parentsFile.type || excelContentType(), upsert: false }
      )
    );
  }

  if(uploads.length){
    const results = await Promise.all(uploads);
    const err = results.find(r => r?.error)?.error;
    if(err) throw err;
  }

  return base;
}

/* =================== Historique UI =================== */
const tblHistory = document.getElementById('tblHistory');
const tblHistoryBody = tblHistory?.querySelector('tbody');
const historyStatus = document.getElementById('historyStatus');
const btnHistoryRefresh = document.getElementById('btnHistoryRefresh');

function renderHistoryEmpty(message){
  if(tblHistoryBody){
    tblHistoryBody.innerHTML = `
      <tr>
        <td colspan="5" style="color:var(--muted)">${message || 'Aucun élément.'}</td>
      </tr>
    `;
  }
  if(historyStatus) historyStatus.textContent = '';
}

function badgeForFile(name){
  const n = String(name||'').toLowerCase();
  if(n.startsWith('result')) return `<span class="badge ok">result</span>`;
  if(n.startsWith('dico')) return `<span class="badge info">dico</span>`;
  if(n.startsWith('trad')) return `<span class="badge info">trad</span>`;
  if(n.startsWith('parents')) return `<span class="badge info">parents</span>`;
  if(n.startsWith('meta')) return `<span class="badge info">meta</span>`;
  return `<span class="badge info">${name}</span>`;
}

function makeActionBtn(label, path, filename){
  return `
    <button class="btn ghost mini" type="button"
      data-download="1"
      data-path="${encodeURIComponent(path)}"
      data-filename="${encodeURIComponent(filename || '')}"
      style="margin-right:6px;margin-top:6px">
      ${label}
    </button>
  `;
}

async function readRunMeta(userId, runId){
  const path = `${userId}/runs/${runId}/meta.json`;
  try{
    const { data, error } = await supabaseClient.storage.from(STORAGE_BUCKET).download(path);
    if(error || !data) return null;
    const txt = await data.text();
    const j = JSON.parse(txt || '{}');
    return j && typeof j === 'object' ? j : null;
  }catch{
    return null;
  }
}

async function upsertRunMeta(userId, runId, patch){
  const path = `${userId}/runs/${runId}/meta.json`;

  let current = {};
  try{
    const { data, error } = await supabaseClient.storage.from(STORAGE_BUCKET).download(path);
    if(!error && data){
      const txt = await data.text();
      current = JSON.parse(txt || '{}') || {};
    }
  }catch{}

  const meta = {
    run_id: runId,
    created_at: current.created_at || new Date().toISOString(),
    ...current,
    ...patch
  };

  const metaBlob = new Blob([JSON.stringify(meta, null, 2)], { type: 'application/json' });

  const { error } = await supabaseClient.storage
    .from(STORAGE_BUCKET)
    .upload(path, metaBlob, { contentType:'application/json', upsert:true });

  if(error) throw error;
}

async function deleteRunFolder(userId, runId){
  const prefix = `${userId}/runs/${runId}`;

  // liste des fichiers (niveau 1 dans le dossier run)
  const { data, error } = await supabaseClient.storage
    .from(STORAGE_BUCKET)
    .list(prefix, { limit: 100, sortBy: { column: 'name', order: 'asc' } });

  if(error) throw error;

  const files = (data || []).filter(f => f?.name && f.id !== null);
  const paths = files.map(f => `${prefix}/${f.name}`);

  if(paths.length){
    const { error: delErr } = await supabaseClient.storage
      .from(STORAGE_BUCKET)
      .remove(paths);
    if(delErr) throw delErr;
  }
}

async function loadHistory(){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){
    renderHistoryEmpty('Connecte-toi pour voir ton historique.');
    return;
  }

  const userId = session.user.id;
  if(historyStatus) historyStatus.textContent = 'Chargement…';
  if(!tblHistoryBody) return;

  const { data: items, error } = await supabaseClient.storage
    .from(STORAGE_BUCKET)
    .list(`${userId}/runs`, { limit: 100, sortBy: { column: 'name', order: 'desc' } });

  if(error){
    renderHistoryEmpty('Erreur Storage: ' + error.message);
    if(historyStatus) historyStatus.textContent = '';
    return;
  }

  const folders = (items || []).filter(it => {
    if(it?.id === null) return true;
    if(it?.id == null && it?.metadata == null) return true;
    return false;
  });

  const runNames = folders.map(f => f.name).filter(Boolean);

  if(!runNames.length){
    renderHistoryEmpty('Aucun run pour l’instant. Lance un traitement, puis reviens ici.');
    if(historyStatus) historyStatus.textContent = '';
    return;
  }

  const maxConcurrent = 6;

  async function listFilesAndMeta(runId){
    const { data, error } = await supabaseClient.storage
      .from(STORAGE_BUCKET)
      .list(`${userId}/runs/${runId}`, { limit: 50, sortBy: { column: 'name', order: 'asc' } });

    const files = (!error && data) ? (data || []).filter(x => x?.id !== null) : [];
    const meta = await readRunMeta(userId, runId);
    return { runId, files, meta, error };
  }

  const results = [];
  for(let i=0;i<runNames.length;i+=maxConcurrent){
    const slice = runNames.slice(i, i+maxConcurrent);
    const chunk = await Promise.all(slice.map(listFilesAndMeta));
    results.push(...chunk);
  }

  tblHistoryBody.innerHTML = '';

  results.forEach(r => {
    const runId = r.runId;
    const files = r.files || [];
    const fileNames = files.map(f => f.name);
    const base = `${userId}/runs/${runId}`;

    const label = (r.meta?.name || '').trim() || '—';

    const filesBadges = fileNames.length
      ? fileNames.map(badgeForFile).join(' ')
      : `<span class="badge err">vide</span>`;

    let actions = '';

    if(fileNames.some(n => String(n).toLowerCase().startsWith('result'))){
      actions += makeActionBtn('Télécharger résultat', `${base}/result.xlsx`, 'result.xlsx');
    } else {
      actions += `<span class="badge err" style="margin-top:6px;display:inline-block">result manquant</span>`;
    }

    const dico = fileNames.find(n => String(n).toLowerCase().startsWith('dico.'));
    const trad = fileNames.find(n => String(n).toLowerCase().startsWith('trad.'));
    const parents = fileNames.find(n => String(n).toLowerCase().startsWith('parents.'));

    if(dico) actions += makeActionBtn('Dico', `${base}/${dico}`, dico);
    if(trad) actions += makeActionBtn('Trad', `${base}/${trad}`, trad);
    if(parents) actions += makeActionBtn('Parents', `${base}/${parents}`, parents);

    // Renommer + Supprimer
    actions += `
      <button class="btn ghost mini" type="button"
        data-rename-run="1"
        data-runid="${encodeURIComponent(runId)}"
        data-currentname="${encodeURIComponent(label)}"
        style="margin-right:6px;margin-top:6px">
        Renommer
      </button>
      <button class="btn ghost mini" type="button"
        data-delete-run="1"
        data-runid="${encodeURIComponent(runId)}"
        style="margin-top:6px">
        Supprimer
      </button>
    `;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${prettyRunDate(runId)}</td>
      <td>${escapeHtml(label)}</td>
      <td style="font-size:12px;color:var(--muted)">${escapeHtml(runId)}</td>
      <td>${filesBadges}</td>
      <td>${actions}</td>
    `;
    tblHistoryBody.appendChild(tr);
  });

  if(historyStatus) historyStatus.textContent = `Runs: ${results.length}`;
}

tblHistoryBody?.addEventListener('click', async (e)=>{
  // Download
  const dl = e.target.closest('button[data-download="1"]');
  if(dl){
    const session = await requireAuthOrGate('Connecte-toi pour télécharger.');
    if(!session) return;

    const path = decodeURIComponent(dl.getAttribute('data-path') || '');
    const fname = decodeURIComponent(dl.getAttribute('data-filename') || '') || path.split('/').pop();
    try{
      await storageSignedDownload(path, fname);
    }catch(err){
      alert('Impossible de télécharger : ' + (err?.message || String(err)));
    }
    return;
  }

  // Rename
  const rn = e.target.closest('button[data-rename-run="1"]');
  if(rn){
    const session = await requireAuthOrGate('Connecte-toi pour renommer.');
    if(!session) return;

    const runId = decodeURIComponent(rn.getAttribute('data-runid') || '');
    const currentName = decodeURIComponent(rn.getAttribute('data-currentname') || '') || '';
    const newName = prompt('Nom du run :', (currentName === '—' ? '' : currentName));
    if(newName == null) return;

    try{
      await upsertRunMeta(session.user.id, runId, { name: newName.trim() || null });
      await loadHistory();
    }catch(err){
      alert('Renommage impossible : ' + (err?.message || String(err)));
    }
    return;
  }

  // Delete
  const del = e.target.closest('button[data-delete-run="1"]');
  if(del){
    const session = await requireAuthOrGate('Connecte-toi pour supprimer.');
    if(!session) return;

    const runId = decodeURIComponent(del.getAttribute('data-runid') || '');
    const ok = confirm(`Supprimer ce run ?\n\n${runId}\n\nCela supprime les fichiers du Storage.`);
    if(!ok) return;

    try{
      del.disabled = true;
      await deleteRunFolder(session.user.id, runId);
      await loadHistory();
    }catch(err){
      alert('Suppression impossible : ' + (err?.message || String(err)));
    }finally{
      del.disabled = false;
    }
    return;
  }
});

btnHistoryRefresh?.addEventListener('click', ()=> loadHistory().catch(()=>{}));

/* =================== Moteur / UI functions =================== */
function normalizeText(s){ if(!s) return ''; return String(s).toLowerCase().replace(/\s+/g,' ').trim(); }
function cleanAndNormalizeUrl(url){ if(!url) return ''; let u=String(url).toLowerCase(); u=u.replace(/^https?:\/\//,''); u=u.replace(/^www\./,''); u=u.replace(/[-_\/?&=]+/g,' '); return normalizeText(u); }
function applyMultiWords(text){ let t=text; state.cfg.multi.forEach(exp=>{ if(!exp) return; const r=new RegExp(exp.replace(/[-\s]+/g,'\\s+'),'gi'); t=t.replace(r,exp.replace(/\s+/g,'-')); }); return t; }
function getTokensFromText(text){ let tokens=text.split(/\s+/).filter(Boolean); tokens=tokens.filter(tok=>!state.cfg.stop.has(tok)); tokens=tokens.map(tok=>state.translations[tok]||tok); return tokens; }
function reduceByActiveDictionaries(tokens){ const active=Object.keys(state.dicos).filter(n=>(state.dicoWeights[n]||{active:true}).active); return tokens.map(tok=>{ for(const name of active){ const dict=state.dicos[name]; for(const key in dict){ if(dict[key].has(tok)||key===tok) return key; } } return tok; }); }
function applySynonymSubstitution(rawUrl){ const clean=cleanAndNormalizeUrl(rawUrl); const mw=applyMultiWords(clean); const t1=getTokensFromText(mw); const t2=reduceByActiveDictionaries(t1); return { clean, substituted:t2.join(' '), tokens:t2 }; }

function buildConfigFromUI(){
  const dictionaries = Object.entries(state.dicos).map(([name, dict]) => ({
    name,
    rows: Object.entries(dict).map(([k, synSet]) => [k, ...Array.from(synSet)].join(','))
  }));
  const bonus = {}, malus = {}, prefilter = {};
  Object.entries(state.dicoWeights || {}).forEach(([name, w]) => {
    bonus[name] = Number(w?.bonus || 0);
    malus[name] = Number(w?.malus || 0);
    prefilter[name] = !!w?.active;
  });
  return {
    stopwords: [...state.cfg.stop],
    exceptions: [...state.cfg.exc],
    multi: state.cfg.multi,
    refRegex: state.cfg.ref,
    translations: Object.entries(state.translations || {}).map(([SOURCE, TRANSLATION]) => ({ SOURCE, TRANSLATION })),
    dictionaries,
    bonus,
    malus,
    prefilter,
    scoreMin: state.cfg.min,
    parents: state.parents || []
  };
}

/* Dico table rendering + badge */
function updatePrefilterBadge(){
  const active=Object.keys(state.dicoWeights).filter(n=> (state.dicoWeights[n]||{}).active);
  if(active.length>0){
    prefilterBadge.textContent='Préfiltre : actif';
    prefilterBadge.className='badge ok';
    prefilterBadge.title='Au moins un dictionnaire actif : le préfiltre est appliqué.';
  } else {
    prefilterBadge.textContent='Préfiltre : inactif';
    prefilterBadge.className='badge info';
    prefilterBadge.title='Activez un dictionnaire pour activer le préfiltre.';
  }
}
function renderDicoTable(){
  if(!tblDico) return;
  tblDico.innerHTML='';
  const names=Object.keys(state.dicos);
  if(names.length===0){
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=5; td.textContent='Aucun dictionnaire chargé.'; td.style.color='var(--muted)';
    tr.appendChild(td); tblDico.appendChild(tr); updatePrefilterBadge(); return;
  }
  names.forEach(name=>{
    const dict=state.dicos[name];
    const w=state.dicoWeights[name]||{bonus:1,malus:1,active:true};
    const entries=Object.keys(dict).length;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHtml(name)}</td>
      <td><input type="number" step="0.1" value="${w.bonus}" data-k="bonus" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff"></td>
      <td><input type="number" step="0.1" value="${w.malus}" data-k="malus" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff"></td>
      <td><input class="switch" type="checkbox" ${w.active?'checked':''} data-k="active"></td>
      <td>${entries.toLocaleString('fr-FR')}</td>
    `;
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('change',()=>{
        const key=inp.dataset.k;
        const row=state.dicoWeights[name]||{bonus:1,malus:1,active:true};
        if(key==='active') row.active=inp.checked;
        else row[key]=Number(inp.value);
        state.dicoWeights[name]=row;
        saveLocal();
        updatePrefilterBadge();
      });
    });
    tblDico.appendChild(tr);
  });
  updatePrefilterBadge();
}
renderDicoTable();

/* Config save */
btnApply.addEventListener('click',()=>{
  state.cfg.stop=new Set(inpStop.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));
  state.cfg.exc=new Set(inpExc.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));
  state.cfg.multi=inpMulti.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  state.cfg.ref=inpRegex.value.trim()||state.cfg.ref;
  state.cfg.min=Number(inpMin.value)||0.5;
  saveLocal();
  logsCfg.value+=(logsCfg.value?'\n':'')+'[CONFIG] Paramètres appliqués.';
});

/* Excel readers */
async function readExcel(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); resolve(wb); }
      catch(err){ reject(err); }
    };
    reader.onerror=reject;
    reader.readAsArrayBuffer(file);
  });
}

fileDico.addEventListener('change',async()=>{
  logsCfg.value='';
  if(!fileDico.files[0]) return;
  try{
    const wb=await readExcel(fileDico.files[0]);
    state.dicos={};
    wb.SheetNames.forEach(name=>{
      const sh=wb.Sheets[name];
      const df=XLSX.utils.sheet_to_json(sh,{header:1,blankrows:false});
      if(df.length===0) return;
      const cols=df[0].map((_,i)=>df.map(row=>row[i]));
      cols.forEach((col,idx)=>{
        const dicoName=String(df[0][idx]||`Dico_${idx+1}`);
        if(!state.dicos[dicoName]) state.dicos[dicoName]={};
        for(let r=1;r<col.length;r++){
          const cell=col[r];
          if(cell==null) continue;
          const items=String(cell).split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
          if(items.length===0) continue;
          const key=items[0];
          state.dicos[dicoName][key]=(state.dicos[dicoName][key]||new Set());
          items.forEach(x=>state.dicos[dicoName][key].add(x));
        }
      });
    });
    saveLocal();
    renderDicoTable();
    logsCfg.value=`[DICO] ${Object.keys(state.dicos).length} dictionnaire(s) chargé(s).`;
  }catch(e){
    logsCfg.value='[DICO][ERREUR] '+(e?.message||String(e));
  }
});

fileTrad.addEventListener('change',async()=>{
  if(!fileTrad.files[0]) return;
  try{
    const wb=await readExcel(fileTrad.files[0]);
    state.translations={};
    wb.SheetNames.forEach(name=>{
      const sh=wb.Sheets[name];
      const arr=XLSX.utils.sheet_to_json(sh);
      arr.forEach(row=>{
        const s=String(row['SOURCE']||'').trim().toLowerCase();
        const t=String(row['TRANSLATION']||'').trim().toLowerCase();
        if(s) state.translations[s]=t;
      });
    });
    saveLocal();
    logsCfg.value=`[TRAD] ${Object.keys(state.translations).length} entrées.`;
  }catch(e){
    logsCfg.value='[TRAD][ERREUR] '+(e?.message||String(e));
  }
});

fileParents.addEventListener('change',async()=>{
  if(!fileParents.files[0]) return;
  try{
    const wb=await readExcel(fileParents.files[0]);
    state.parents=[];
    wb.SheetNames.forEach(name=>{
      const sh=wb.Sheets[name];
      const arr=XLSX.utils.sheet_to_json(sh);
      arr.forEach(row=>{
        if(row.URL) state.parents.push(String(row.URL));
      });
    });
    saveLocal();
    logsCfg.value=`[PARENTS] ${state.parents.length} URLs.`;
  }catch(e){
    logsCfg.value='[PARENTS][ERREUR] '+(e?.message||String(e));
  }
});

/* Test URL (PAS BLOQUÉ PAR AUTH) */
btnTest.addEventListener('click', async () => {
  const url = testUrl.value.trim();
  if(!url){ testOut.value = 'Veuillez saisir une URL.'; return; }
  try{
    const payload = { url, config: buildConfigFromUI() };
    const r = await fetch(buildUrl('/debug-url'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('HTTP '+r.status+' – '+await r.text()); }
    const j = await r.json();

    const out = [];
    out.push(`URL brute : ${j.input}`);
    out.push('URL nettoyée :');
    out.push(' → ' + j.clean);
    out.push('Après synonymes :');
    out.push(' → ' + j.substituted);
    out.push('Tokens :');
    out.push(j.tokens?.length ? (' → ' + j.tokens.join(', ')) : ' → Aucun token');
    out.push(j.reference ? `Référence détectée : ${j.reference}` : 'Aucune référence détectée via la regex.');
    testOut.value = out.join('\n');
  }catch(e){
    testOut.value = '[ERREUR] ' + (e?.message || String(e));
  }
});

/* ===================== Run Summary Modal (PRO) ===================== */
const runSummaryModal = document.getElementById('runSummaryModal');
const runSummaryContent = document.getElementById('runSummaryContent');
const rsSubtitle = document.getElementById('rsSubtitle');
const btnRunSummaryClose = document.getElementById('btnRunSummaryClose');
const btnRunSummaryOk = document.getElementById('btnRunSummaryOk');
const btnRunSummaryDownload = document.getElementById('btnRunSummaryDownload');
const runSummaryBackdrop = document.getElementById('runSummaryBackdrop');

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}
function openRunSummaryModal(){ runSummaryModal?.classList.remove('hidden'); }
function closeRunSummaryModal(){ runSummaryModal?.classList.add('hidden'); }
btnRunSummaryClose?.addEventListener('click', closeRunSummaryModal);
btnRunSummaryOk?.addEventListener('click', closeRunSummaryModal);
runSummaryBackdrop?.addEventListener('click', closeRunSummaryModal);

function toNumberSafe(v){
  const n = Number(String(v ?? '').replace(',', '.'));
  return Number.isFinite(n) ? n : NaN;
}
async function buildRunSummaryFromBlob(blob){
  const ab = await blob.arrayBuffer();
  const wb = XLSX.read(ab, { type: 'array' });
  const sh = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sh, { defval: "" });

  const total = rows.length;
  const scoreKey = "similarity_top1";
  const url404Key = "URL_404";
  const url200Key = "URL_200_top1";

  const scored = rows
    .map((r) => ({
      score: toNumberSafe(r[scoreKey]),
      url404: String(r[url404Key] ?? ''),
      url200: String(r[url200Key] ?? '')
    }))
    .filter(x => Number.isFinite(x.score));

  scored.sort((a,b)=> b.score - a.score);

  const nScored = scored.length;
  const k = Math.max(1, Math.floor(nScored * 0.10));
  const startIndex = Math.max(0, nScored - k);
  const bottom = scored.slice(startIndex);

  const threshold = (nScored > 0) ? scored[startIndex]?.score : null;
  const startLineExcel = (startIndex + 1) + 1;
  const worst5 = bottom.slice().sort((a,b)=> a.score - b.score).slice(0, 5);

  return { total, nScored, k, threshold, startLineExcel, worst5 };
}
function renderRunSummary(summary){
  const { total, nScored, k, threshold, startLineExcel, worst5 } = summary;
  if(rsSubtitle){
    const thrTxt = (threshold == null) ? 'n/a' : (Math.round(threshold * 100) / 100);
    rsSubtitle.textContent = `Seuil de vérif (score ≤ ${thrTxt}) · basé sur les scores.`;
  }
  const thrTxt = (threshold == null) ? 'n/a' : (Math.round(threshold * 100) / 100);
  const tableRows = worst5.map((x, idx) => {
    const s = Math.round(x.score * 100) / 100;
    return `
      <tr>
        <td>${idx + 1}</td>
        <td><b>${s}</b></td>
        <td class="rs-url">${escapeHtml(x.url404)}</td>
        <td class="rs-url">${escapeHtml(x.url200)}</td>
      </tr>
    `;
  }).join('');

  runSummaryContent.innerHTML = `
    <div class="rs-kpis">
      <div class="rs-kpi">
        <div class="label">URLs traitées</div>
        <div class="value">${Number(total).toLocaleString('fr-FR')}</div>
        <div class="hint">Total lignes (hors en-tête)</div>
      </div>
      <div class="rs-kpi">
        <div class="label">Scores exploitables</div>
        <div class="value">${Number(nScored).toLocaleString('fr-FR')}</div>
        <div class="hint">Basé sur “similarity_top1”</div>
      </div>
      <div class="rs-kpi">
        <div class="label">URLs à vérifier</div>
        <div class="value">${Number(k).toLocaleString('fr-FR')}</div>
        <div class="hint">Score ≤ ${thrTxt}</div>
      </div>
    </div>

    <div class="rs-callout">
      <b>URLs à vérifier à partir de la ligne ${Number(startLineExcel).toLocaleString('fr-FR')}</b>
      (dans Excel <b>après</b> tri de <b>similarity_top1</b> par ordre décroissant).
    </div>

    <div class="card" style="padding:0;border-radius:12px;box-shadow:none">
      <div style="padding:12px 12px 0 12px;font-weight:800">Top 5 à vérifier</div>
      <div style="padding:10px 12px 12px 12px;color:var(--muted);font-size:12px">
        Les plus faibles scores (échantillon pour contrôle rapide).
      </div>

      <div style="padding:0 12px 12px 12px">
        <table class="rs-table">
          <thead>
            <tr>
              <th style="width:55px">#</th>
              <th style="width:90px">Score</th>
              <th>URL 404</th>
              <th>URL 200</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows || `<tr><td colspan="4" style="color:var(--muted);padding:12px">Aucune donnée.</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

btnRunSummaryDownload?.addEventListener('click', () => {
  if (!resultBlobUrl) return;
  const a = document.createElement('a');
  a.href = resultBlobUrl;
  a.download = resultFilename || 'result.xlsx';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ===================== Progress helpers ===================== */
let elapsedTimer = null;
let progressTimer = null;
let startedAt = null;

function fmtElapsed(ms) {
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2, '0')}`;
}
function setStatus(kind, text){
  matchStatus.textContent = text;
  matchStatus.className = 'badge ' + kind;
}
function setProgress(pct){
  const v = Math.max(0, Math.min(100, pct));
  matchBar.style.width = v + '%';
}
function stopProgressTimers(){
  if (elapsedTimer) clearInterval(elapsedTimer);
  if (progressTimer) clearInterval(progressTimer);
  elapsedTimer = null;
  progressTimer = null;
  startedAt = null;
}
async function estimateSecondsFromFiles(){
  try{
    const wb404 = await readExcel(file404.files[0]);
    const sh404 = wb404.Sheets['404'] || wb404.Sheets[wb404.SheetNames[0]];
    const arr404 = XLSX.utils.sheet_to_json(sh404);
    const n = Math.max(1, arr404.length || 1);
    const sec = Math.max(20, Math.round(10 + n * 0.06));
    return sec;
  }catch{
    return 90;
  }
}
function startFakeProgress(estimatedSec){
  const cap = 92;
  const start = Date.now();
  progressTimer = setInterval(()=>{
    const t = (Date.now() - start) / 1000;
    const ratio = Math.min(1, t / estimatedSec);
    const eased = 1 - Math.pow(1 - ratio, 3);
    const pct = Math.min(cap, Math.floor(eased * cap));
    setProgress(pct);
    matchMeta.textContent = `Traitement en cours… (~${pct}%)`;
  }, 250);
}

/* Clear */
btnClear.addEventListener('click',()=>{
  logsMatch.value='';
  file404.value='';
  file200.value='';
  resetDownloadUI();
  stopProgressTimers();
  setProgress(0);
  matchMeta.textContent='En attente…';
  matchElapsed.textContent='0:00';
  matchHint.textContent='';
  setStatus('info','idle');
  closeRunSummaryModal();
});

/* Matching (BLOQUÉ si pas connecté) */
btnRun.addEventListener('click', async () => {
  const session = await requireAuthOrGate('Connecte-toi pour lancer le matching.');
  if(!session) return;

  logsMatch.value = '';
  resetDownloadUI();
  closeRunSummaryModal();

  if (!file404.files[0] || !file200.files[0]) {
    logsMatch.value = "Veuillez importer les deux fichiers (404 et 200).";
    return;
  }

  btnRun.disabled = true;
  btnClear.disabled = true;

  try {
    stopProgressTimers();
    setProgress(0);
    setStatus('info','en cours');
    matchMeta.textContent = 'Préparation…';
    matchElapsed.textContent = '0:00';

    startedAt = Date.now();
    elapsedTimer = setInterval(()=>{
      matchElapsed.textContent = fmtElapsed(Date.now() - startedAt);
    }, 250);

    const estSeconds = await estimateSecondsFromFiles();
    matchHint.textContent = `Estimation : ~${Math.round(estSeconds)}s`;
    startFakeProgress(estSeconds);

    const form = new FormData();
    form.append('file404', file404.files[0]);
    form.append('file200', file200.files[0]);
    form.append('config', JSON.stringify(buildConfigFromUI()));

    logsMatch.value = '[0%] Upload en cours…';
    matchMeta.textContent = 'Upload en cours…';

    const token = session?.access_token || null;
    const headers = {};
    if (token) headers['Authorization'] = `Bearer ${token}`;

    setProgress(Math.max(8, parseInt(matchBar.style.width || '0', 10)));
    logsMatch.value += '\n[20%] Envoi vers l’API…';

    const r = await fetch(buildUrl('/match'), { method: 'POST', headers, body: form });

    logsMatch.value += '\n[60%] Traitement côté API…';

    if (!r.ok) {
      const txt = await r.text();
      throw new Error('HTTP ' + r.status + ' – ' + txt);
    }

    const blob = await r.blob();
    logsMatch.value += '\n[90%] Réception du résultat…';

    stopProgressTimers();
    setProgress(100);
    setStatus('ok','terminé');
    matchMeta.textContent = 'Terminé. Résultat prêt.';

    // Téléchargement immédiat (local)
    resultBlobUrl = URL.createObjectURL(blob);
    resultFilename = 'result.xlsx';
    downloadWrap.classList.remove('hidden');
    downloadLabel.textContent = 'Résultat prêt : ' + resultFilename;

    logsMatch.value += '\n[95%] Sauvegarde dans ton historique (Storage)…';

    const runId = makeRunId();
    try{
      await uploadRunFolder({
        userId: session.user.id,
        runId,
        resultBlob: blob,
        dicoFile: fileDico?.files?.[0] || null,
        tradFile: fileTrad?.files?.[0] || null,
        parentsFile: fileParents?.files?.[0] || null
      });

      logsMatch.value += `\n[100%] Sauvegardé ✔ (run: ${runId})`;
    }catch(storageErr){
      logsMatch.value += '\n[WARN] Stockage historique non fait : ' + (storageErr?.message || String(storageErr));
    }

    // POPUP recap fin de run
    try{
      const summary = await buildRunSummaryFromBlob(blob);
      renderRunSummary(summary);
      openRunSummaryModal();
    }catch(e){}

  } catch (e) {
    stopProgressTimers();
    setProgress(0);
    setStatus('err','erreur');
    matchMeta.textContent = 'Erreur pendant le traitement.';
    logsMatch.value = '[ERREUR] ' + (e?.message || String(e));
    resetDownloadUI();
  } finally {
    btnRun.disabled = false;
    btnClear.disabled = false;
  }
});
</script>
</body>
</html>
